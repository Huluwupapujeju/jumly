// jumly-0.1.2a, tomotaka.sakuma 2011-2012 copyright(c), all rights reserved.
(function(){var Logger,max,min,_align;var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=Array.prototype.indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(this[i]===item){return i}}return -1};max=function(a,b){return b-a};min=function(a,b){return a-b};jQuery.choose=function(nodes,ef,cmpf){return jQuery.map(nodes,ef).sort(cmpf)[0]};jQuery.max=function(nodes,ef){return jQuery.choose(nodes,ef,max)};jQuery.min=function(nodes,ef){return jQuery.choose(nodes,ef,min)};jQuery.fn.choose=function(ef,cmpf){return jQuery.choose(this,ef,cmpf)};jQuery.fn.max=function(ef){return jQuery.max(this,ef)};jQuery.fn.min=function(ef){return jQuery.min(this,ef)};jQuery.fn.pickup2=function(f0,f1,f2){var prev;if(this.length===0){return this}f0(prev=$(this[0]));if(this.length===1){return this}return this.slice(1).each(__bind(function(i,curr){curr=$(curr);if((f2!=null)&&(i+1===this.length-1)){f2(prev,curr,i+1)}else{f1(prev,curr,i+1)}return prev=curr},this))};jQuery.fn.swallow=function(_,f){f=f||jQuery.fn.append;if(_.length===1){if(_.index()===0){_.parent().prepend(this)}else{this.insertAfter(_.prev())}}else{if(_.index()===0){this.prependTo($(_[0]).parent())}else{this.insertBefore(_[0])}}this.append(_.detach());return this};jQuery.fn.cssAsInt=function(name){var a;a=this.css(name);if(a){return parseInt(a)}else{return 0}};jQuery.fn.cssLeft=function(){return this.css("left").toInt()};jQuery.fn.outerRight=function(){return this.offset().left+this.outerWidth()};jQuery.fn.mostLeftRight=function(){return{left:this.min(function(e){return $(e).offset().left}),right:this.max(function(e){var t;t=$(e).offset().left+$(e).outerWidth();if(t-1<0){return 0}else{return t-1}}),width:function(){if((this.right!=null)&&(this.left!=null)){return this.right-this.left+1}else{return 0}}}};jQuery.fn.mostTopBottom=function(){return{top:this.min(function(e){return $(e).offset().top}),bottom:this.max(function(e){var t;t=$(e).offset().top+$(e).outerHeight();if(t-1<0){return 0}else{return t-1}}),height:function(){if((this.top!=null)&&(this.bottom!=null)){return this.bottom-this.top+1}else{return 0}}}};jQuery.fn.align=function(dir,base){var f;base=$(base||this[0]);switch(dir){case"bottom":case"south":f=function(i,e){return{top:base.outerHeight()-$(e).outerHeight()}};break;default:throw"unspported: "+dir}return this.each(function(i,e){return $(e).offset(f(i,e))})};String.prototype.toInt=function(){if(this.length>0){return parseInt(this)}else{return 0}};_align=function(me,base,klass){var pos;me.addClass(klass);pos=base.offset();switch(klass){case"left":pos.left-=me.outerWidth();break;case"right":pos.left+=base.outerWidth();break;case"above":pos.top-=me.outerHeight();break;case"below":pos.top+=base.outerHeight()}return me.offset(pos)};jQuery.fn.alignAt=function(base,pos){return _align(this,base,pos)};Logger=(function(){function Logger(category){this.category=category}return Logger})();Logger.prototype.out=function(cate,lv,msg){return console.log(""+cate+":"+lv+" --",msg,arguments[3],arguments[4],arguments[5])};Logger.prototype.err=function(cate,lv,msg){return console.error(""+cate+":"+lv+" --",msg,arguments[3],arguments[4],arguments[5])};Logger.prototype.log=function(lv,msg){return this.out(this.category,lv,msg)};Logger.prototype.debug=function(s,a,b,c,d){return this.log("debug",s,a,b,c,d)};Logger.prototype.info=function(s,a,b,c,d){return this.log("info",s,a,b,c,d)};Logger.prototype.error=function(s,a,b,c,d){return this.err(this.category,"error",s,a,b,c,d)};$.logger=function(category){return new Logger(category)};$.kindof=function(that){var tc,toName;if(that===null){return"Null"}if(that===void 0){return"Undefined"}tc=that.constructor;toName=function(f){if(__indexOf.call(f,"name")>=0){return f.name}else{return(""+f).replace(/^function\s+([^\(]*)[\S\s]+$/im,"$1")}};if(typeof tc==="function"){return toName(tc)}else{return tc}}}).call(this);(function(){var Shape,shape_arrow,to_polar_from_cartesian,_line_to,_render_both,_render_dashed,_render_dashed2,_render_line,_render_line2,_render_normal;var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Shape=(function(){function Shape(ctxt){this.ctxt=ctxt;this.pos={left:0,top:0};this.memento=[]}return Shape})();Shape.prototype.backtrack=function(depth){var i,m;this.ctxt.save();this.ctxt.scale(1,-1);i=0;while(m=this.memento.pop()){m();i+=1;if(i>=depth){break}}this.ctxt.restore();return this};Shape.prototype.line=function(dx,dy,b){var _pos;this.pos.left+=dx;this.pos.top+=dy;this.ctxt.lineTo(this.pos.left,this.pos.top);_pos={left:this.pos.left,top:this.pos.top};this.memento.push(__bind(function(rx,ry){return this.ctxt.lineTo(_pos.left-dx,_pos.top-dy)},this));return this};Shape.prototype.move=function(dx,dy){var _pos;this.pos.left+=dx;this.pos.top+=dy;this.ctxt.moveTo(this.pos.left,this.pos.top);_pos={left:this.pos.left,top:this.pos.top};this.memento.push(__bind(function(rx,ry){return this.ctxt.moveTo(_pos.left-dx,_pos.top-dy)},this));return this};Shape.prototype.lineTo=function(p,q){var _pos;_pos={left:this.pos.left,top:this.pos.top};this.ctxt.lineTo(p,q);this.pos.left=p;this.pos.top=q;this.memento.push(__bind(function(){return this.ctxt.lineTo(_pos.left,_pos.top)},this));return this};Shape.prototype.moveTo=function(p,q){var _pos;_pos={left:this.pos.left,top:this.pos.top};this.ctxt.moveTo(p,q);this.pos.left=p;this.pos.top=q;this.memento.push(__bind(function(){return this.ctxt.moveTo(_pos.left,_pos.top)},this));return this};to_polar_from_cartesian=function(src,dst){var dx,dy;dx=dst.left-src.left;dy=dst.top-src.top;return{offset:{left:src.left,top:src.top},radius:Math.sqrt(dx*dx+dy*dy),declination:Math.atan(dy/dx),quadrants:{x:dx!==0?dx/Math.abs(dx):1,y:dy!==0?dy/Math.abs(dy):1}}};_line_to=function(ctxt,src,dst,styles){var i,p,pattern,plen,x,_ref;if(!styles){ctxt.moveTo(src.left,src.top);ctxt.lineTo(dst.left,dst.top);return}styles=$.extend({pattern:[4,4]},styles);p=to_polar_from_cartesian(src,dst);ctxt.save();ctxt.translate(p.offset.left,p.offset.top);ctxt.rotate(p.declination);ctxt.scale(p.quadrants.x,p.quadrants.y);ctxt.moveTo(0,0);pattern=styles.pattern;plen=pattern[0]+pattern[1];if(p.radius>0){for(i=0,_ref=p.radius-1;0<=_ref?i<=_ref:i>=_ref;i+=plen){x=i+pattern[0];if(p.radius-1<=x){x=p.radius-1}ctxt.lineTo(x,0);ctxt.moveTo(i+plen,0)}}return ctxt.restore()};_render_both=function(ctxt,a,r,e,dt){a.line(e.height,e.width+dt).line(0,-dt).line(r-e.height*2,0).line(0,dt).line(e.height,-(e.width+dt)).backtrack();return ctxt.closePath()};_render_line=function(ctxt,a,r,e,dt){a.moveTo(0,0).line(r,0).line(-e.height,e.base).move(e.height,-e.base).line(-e.height,-e.base);return delete e.fillStyle};_render_line2=function(ctxt,a,r,e,dt){return a.moveTo(0,0).line(r-e.height,0).line(0,e.base).line(e.height,-e.base).backtrack()};_render_dashed=function(ctxt,a,r,e,dt){_line_to(ctxt,{left:0,top:0},{left:r,top:0},{pattern:e.pattern});_line_to(ctxt,{left:r,top:0},{left:r-e.height,top:e.base});_line_to(ctxt,{left:r,top:0},{left:r-e.height,top:-e.base});return delete e.fillStyle};_render_dashed2=function(ctxt,a,r,e,dt){_line_to(ctxt,{left:0,top:0},{left:r-e.height,top:0},{pattern:e.pattern});return a.moveTo(r-e.height,0).line(0,e.base).line(e.height,-e.base).line(-e.height,-e.base).line(0,e.base)};_render_normal=function(ctxt,a,r,e,dt){a.moveTo(0,0).line(0,e.width).line(r-e.height,0).line(0,dt).line(e.height,-(e.width+dt)).backtrack();return ctxt.closePath()};shape_arrow=function(ctxt,src,dst,styles){var a,dt,e,p,r,_ref;p=to_polar_from_cartesian({left:src.x,top:src.y},{left:dst.x,top:dst.y});r=p.radius;ctxt.save();ctxt.translate(src.x,src.y);ctxt.rotate(p.declination);ctxt.scale(p.quadrants.x,p.quadrants.y);e=$.extend({width:20,base:35,height:50,pattern:[4,4],shape:null},styles);if((_ref=e.lineWidth)==null){e.lineWidth=1}$.extend(ctxt,e);ctxt.beginPath();if(e.tosrc){ctxt.translate(r,0);ctxt.rotate(Math.PI)}a=new Shape(ctxt);dt=e.base-e.width;switch(styles.shape){case"both":_render_both(ctxt,a,r,e,dt);break;case"line":_render_line(ctxt,a,r,e,dt);break;case"dashed":_render_dashed(ctxt,a,r,e,dt);break;case"dashed2":_render_dashed2(ctxt,a,r,e,dt);break;case"line2":_render_line2(ctxt,a,r,e,dt);break;default:_render_normal(ctxt,a,r,e,dt)}ctxt.stroke();if(e.fillStyle){ctxt.fill()}return ctxt.restore()};$.g2d={arrow:shape_arrow,path:Shape}}).call(this);(function(){var DSL,DSL_,JUMLYDiagramLayout,JUMLYError,SCRIPT_TYPE_PATTERN,jumly,preferences_,prefs_,run_scripts,run_scripts_done,toTypeString;var __hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(window.JUMLY){throw new Error("JUMLY already exists.")}window.JUMLY={};jumly=function(arg,opts){var a,factory,mapJqToJy,meta;if(typeof arg==="object"&&!arg.type){mapJqToJy=function(arg){var a,i,_ref;if(typeof arg==="object"&&!(typeof arg.length==="number"&&typeof arg.data==="function")){arg=$(arg)}for(i=0,_ref=arg.length-1;0<=_ref?i<=_ref:i>=_ref;0<=_ref?i++:i--){a=$(arg[i]).self();arg[i]=!a?null:a}return arg};return mapJqToJy(arg)}arg=$.extend({},typeof arg==="string"?{type:arg}:arg);meta=jumly.factory[arg.type];if(meta===void 0){throw"unknown type '"+arg.type+"'"}factory=meta.factory;opts=$.extend({name:null},typeof opts==="object"?opts:{name:opts});a=factory(arg,opts);a.find(".name:eq(0)").html(opts.name);if(opts.name){a.name(opts.name)}a.attr({id:opts.id?opts.id:void 0});a.gives=jumly.lang._gives(a,arg);a.data("uml:property",{_self:a,type:arg.type,name:opts.name,stereotypes:function(){return[]}});return a};$.fn.self=function(){var _ref;return(_ref=this.data("uml:property"))!=null?_ref._self:void 0};$.fn.selfEach=function(f){return this.each(function(i,e){e=$(e).self();if(e==null){throw new Error("self() returned undefined.",e)}f(e);return this})};jumly.identify=function(e){var p;if(!e){return null}if(((function(){var _results;_results=[];for(p in e){_results.push(p)}return _results})()).length===1&&p==="id"){switch(typeof e.id){case"number":case"string":return e.id;case"function":return e.id();default:return null}}};jumly.normalize=function(a,b){var attrs,key,r,val;if(a===void 0||a===null){return a}switch(typeof a){case"string":return $.extend({name:a},b);case"boolean":case"number":return null}if($.isArray(a)){return null}if(a.hasOwnProperty("id")){return a}r={};for(key in a){val=a[key];if(typeof key==="string"&&key.match(/[1-9][0-9]*/)&&typeof val==="string"){r.id=parseInt(key);r.name=val}else{r[key]=val}}if(r.hasOwnProperty("name")){return r}else{r.name=key;attrs=r[key];delete r[key];return $.extend(r,attrs)}};jumly.factory=function(name,fact){return jumly.factory[name]={factory:fact}};JUMLY.define=function(name,type){return jumly.factory(name,function(_,opts){return new type(_,opts)})};jumly.def=JUMLY.define;$.uml=jumly;$.jumly=$.uml;jumly.lang={_gives:function(a,dic){var f,gives;gives=function(query){var r;r=dic[query];if(r){return r}else{return null}};if(!a.gives){return gives}f=a.gives;return function(query){var r;r=f(query);if(r.length>0||r.of||r.as){return r}return gives(query)}},_as:function(m){return{as:function(e){return m[e]}}},_of:function(nodes,query){return function(unode){var n;n=nodes.filter(function(i,e){var s;e=jumly(e)[0];s=e.gives(unode.data("uml:property").type);if(s===unode){return e}else{return null}});if(n.length>0){return jumly(n)[0]}else{return[]}}}};run_scripts_done=false;run_scripts=function(){var diagrams,s,script,scripts,_i,_len;if(run_scripts_done){return null}scripts=document.getElementsByTagName("script");diagrams=(function(){var _i,_len,_results;_results=[];for(_i=0,_len=scripts.length;_i<_len;_i++){s=scripts[_i];if(s.type.match(/text\/jumly+(.*)/)){_results.push(s)}}return _results})();for(_i=0,_len=diagrams.length;_i<_len;_i++){script=diagrams[_i];jumly.run_script_(script)}run_scripts_done=true;return null};jumly.runScripts_=run_scripts;jumly[":preferences"]={run_script:{before_compose:function(diag,target,script){var _ref;if(((_ref=target[0])!=null?_ref.localName:void 0)==="head"){return diag.appendTo($("body"))}else{if(script.attr("target-id")){return target.html(diag)}else{return diag.insertAfter(script)}}},determine_target:function(script){var targetid;targetid=script.attr("target-id");if(targetid){return $("#"+targetid)}else{return script.parent()}}}};SCRIPT_TYPE_PATTERN=/text\/jumly-(.*)-diagram|text\/jumly\+(.*)|application\/jumly\+(.*)/;toTypeString=function(type){var kind;if(!type.match(SCRIPT_TYPE_PATTERN)){throw"Illegal type: "+type}return kind=RegExp.$1+RegExp.$2+RegExp.$3};jumly.run_script_=function(script){var compiler,diag,kind,prefs,target,type;script=$(script);type=script.attr("type");if(!type){throw"Not found: type attribute in script"}kind=toTypeString(type);compiler=jumly.DSL("."+kind+"-diagram");if(!compiler){throw"Not found: compiler for '."+kind+"'"}if(!compiler.compileScript){throw"Not found: compileScript"}diag=compiler.compileScript(script);prefs=jumly[":preferences"].run_script;target=prefs.determine_target(script);prefs.before_compose(diag,target,script);return diag.compose()};if(window.addEventListener){addEventListener("DOMContentLoaded",run_scripts)}else{throw"window.addEventListener is not supported"}prefs_={};preferences_=function(a,b){if(!b&&typeof a==="string"){return prefs_[a]}return prefs_[a]=$.extend(prefs_[a],b)};jumly.preferences=preferences_;$.fn.name=function(n){var _ref,_ref2;if(arguments.length===0||n===void 0){return(_ref=this.data("uml:property"))!=null?_ref.name:void 0}this.find(".name:eq(0)").html(n);if((_ref2=this.data("uml:property"))!=null){_ref2.name=n}return this};$.fn.stereotype=function(n){var _ref,_ref2;if(arguments.length===0||n===void 0){return(_ref=this.data("uml:property"))!=null?_ref.stereotype:void 0}this.find(".stereotype:eq(0)").html(n);if((_ref2=this.data("uml:property"))!=null){_ref2.stereotype=n}switch(this.data("uml:property").type){case".interaction":this.find(".message:eq(0)").self().stereotype(n);break;case".message":this.addClass(n)}return this};$.fn.right=function(){return this.offset().left+this.width()-1};$.fn.outerBottom=function(){return this.offset().top+this.outerHeight()-1};jumly.runScript=jumly.run_script_;DSL_={};DSL=function(args){if(args===null){throw"It MUST NOT be null."}if(typeof args==="string"){return DSL_[args]}if(!(typeof args==="object"&&!$.isArray(args))){throw"DSL can only accept an object."}if(!args.type){throw"type property is required."}if(!args.compileScript){throw"compileScript property is required."}return DSL_[args.type]={compileScript:args.compileScript,version:args.version}};jumly.DSL=DSL;JUMLY.Naming={toID:function(that){if(that.constructor===jQuery){return that.attr("id")}return that.toLowerCase().replace(/[^a-zA-Z0-9_]/g,"-")},toRef:function(s){if(s.match(/^[0-9].*/)){return"_"+s}else{return s.replace(/^[0-9]|-/g,"_")}},toCSSClass:function(s){return s.replace(/^JUMLY/,"").replace(/Diagram$/,"-Diagram").toLowerCase()}};JUMLY.Identity={normalize:function(that){var a,id,it,keys,mods,name,p,toID;toID=JUMLY.Naming.toID;switch($.kindof(that)){case"String":return{id:toID(that),name:that};case"Object":break;default:if(that&&that.constructor===jQuery){id=toID(that);name=that.find(".name");if((id!=null)||(name.length>0)){return{id:id,name:(name.html()?name.html():void 0)}}else{return}}console.error("Cannot recognize kind:",that);throw new Error("Cannot recognize kind: '"+($.kindof(that))+"'")}keys=(function(){var _results;_results=[];for(p in that){_results.push(p)}return _results})();if(keys.length>1){return that}id=keys[0];it=that[keys[0]];if($.kindof(it)==="String"){return{id:id,name:it}}keys=(function(){var _results;_results=[];for(p in it){_results.push(p)}return _results})();if(keys.length>1){return $.extend({},it,{id:toID(id),name:id})}name=keys[0];mods=it[keys[0]];switch($.kindof(mods)){case"Object":return $.extend({id:id,name:name},mods);case"Array":case"Function":a={id:toID(id),name:id};a[name]=mods;return a}}};jumly.build=function(script){var builderType,type;type=toTypeString(script.attr("type"));builderType=((function(){switch(type){case"class":return JUMLY.ClassDiagramBuilder;case"usecase":return JUMLY.UsecaseDiagramBuilder;case"sequence":return JUMLY.SequenceDiagramBuilder}})());return(new builderType).build(script.text())};JUMLYDiagramLayout=(function(){function JUMLYDiagramLayout(){}return JUMLYDiagramLayout})();JUMLYDiagramLayout.prototype._q=function(sel){return $(sel,this.diagram)};JUMLYDiagramLayout.prototype.layout=function(diagram){this.diagram=diagram;this.prefs=diagram.preferences();return typeof this._layout_==="function"?this._layout_():void 0};JUMLY.DiagramLayout=JUMLYDiagramLayout;JUMLYError=(function(){__extends(JUMLYError,Error);function JUMLYError(type,message,arguments,cause,jumlipt){this.type=type;this.message=message;this.arguments=arguments;this.cause=cause;this.jumlipt=jumlipt;if(typeof this.type==="object"){this.type=p.type;this.message=p.message;this.arguments=p.arguments}}return JUMLYError})();JUMLY.Error=JUMLYError}).call(this);(function(){var JUMLYPreferences;JUMLYPreferences=(function(){function JUMLYPreferences(){}JUMLYPreferences.put=function(a,b){return JUMLYPreferences.values[a]=b};JUMLYPreferences.get=function(a){var e;e=JUMLYPreferences.values[a];if(typeof e==="function"){return e()}else{return e}};return JUMLYPreferences})();JUMLY.Preferences=function(a){var e,k;if(typeof a==="string"){return JUMLYPreferences.get(a)}else{k=((function(){var _results;_results=[];for(e in a){_results.push(e)}return _results})())[0];return JUMLYPreferences.put(k,a[k])}};JUMLYPreferences.values={"document.id.validation.enable":false}}).call(this);(function(){var DiagramBuilder,JUMLYDiagram,JUMLYHTMLElement,JUMLYNote,JUMLYObject,JUMLYRelationship,MESSAGE_STYLE,consts,uml,_STYLES,_actor_renderer,_base,_controller_renderer,_entity_renderer,_path,_ref,_render_actor,_render_controller,_render_entity,_render_icon,_render_view,_size_canvas,_view_renderer;var __hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};JUMLYHTMLElement=(function(){function JUMLYHTMLElement(){var a,cls,p,_ref;cls=JUMLY.Naming.toCSSClass(this.constructor.name);p=$.extend(this,$("<div>").addClass(cls));a=Array.prototype.slice.apply(arguments);a.unshift(p);if((_ref=this._build_)!=null){_ref.apply(this,a)}this}return JUMLYHTMLElement})();JUMLY.HTMLElement=JUMLYHTMLElement;JUMLYDiagram=(function(){__extends(JUMLYDiagram,JUMLY.HTMLElement);function JUMLYDiagram(){JUMLYDiagram.__super__.constructor.apply(this,arguments)}JUMLYDiagram.isIDExisting=function(id,diag){if(JUMLY.Preferences("document.id.validation.enable")){return $("#"+id).length>0}else{return false}};return JUMLYDiagram})();JUMLYDiagram.prototype._build_=function(div){return div.addClass("diagram")};JUMLYDiagram.prototype._def_=function(varname,e){return eval(""+varname+" = e")};JUMLYDiagram.prototype._regByRef_=function(id,obj){var ref,_base;ref=JUMLY.Naming.toRef(id);if(this[ref]){throw new Error(("Already exists for '"+ref+"' in the ")+$.kindof(this))}if(typeof(_base=JUMLY.Diagram).isIDExisting==="function"?_base.isIDExisting(id,this):void 0){throw new Error("Element which has same ID("+id+") already exists in the document.")}this[ref]=obj;return ref};JUMLY.Diagram=JUMLYDiagram;DiagramBuilder=(function(){function DiagramBuilder(){}DiagramBuilder.selectHTMLScriptElements=function(element){return $("script",element).not(".ignored")};return DiagramBuilder})();DiagramBuilder.prototype.beforeCompose=function(f){this.diagram.bind("beforeCompose",f);return this};DiagramBuilder.prototype.afterCompose=function(f){this.diagram.bind("afterCompose",f);return this};DiagramBuilder.prototype.before=function(){return this.beforeCompose.apply(this,arguments)};DiagramBuilder.prototype.after=function(){return this.afterCompose.apply(this,arguments)};DiagramBuilder.prototype.accept=function(closure){return closure.apply(this,[])};DiagramBuilder.prototype.build=function(jumlipt){var typename;try{typename=this.constructor.name.replace(/^JUMLY/,"").replace(/Diagram(Builder)?$/,"").toLowerCase();this.diagram=$.jumly("."+typename+"-diagram");this.accept(function(){return eval(CoffeeScript.compile(jumlipt))});this.diagram.trigger("build.after");return this.diagram}catch(ex){if(this.verbose){$.logger(this).error(ex,ex.stack,jumlipt)}throw new JUMLY.Error("failed_to_build","Failed to build",[],ex,jumlipt)}};DiagramBuilder.prototype.note=function(text){return $.jumly(".note").find(".content").html(text).end().appendTo(this.diagram)};JUMLY.DiagramBuilder=DiagramBuilder;uml=jQuery.uml;JUMLYObject=(function(){function JUMLYObject(props,opts){jQuery.extend(this,JUMLYObject.newNode())}JUMLYObject.newNode=function(){return $("<div>").addClass("object").append($("<div>").addClass("name"))};return JUMLYObject})();JUMLYObject.prototype.activate=function(){var iact,occurr,_as;_as=uml.lang._as;occurr=uml({type:".occurrence",".object":this});iact=uml({type:".interaction",".occurrence":_as({".actor":null,".actee":occurr}),".actor":null,".actee":occurr});iact.addClass("activated");iact.find(".message").remove();iact.append(occurr);this.parent().append(iact);return occurr};JUMLYObject.prototype.isLeftAt=function(a){return this.offset().left<a.offset().left};JUMLYObject.prototype.isRightAt=function(a){return(a.offset().left+a.width())<this.offset().left};JUMLYObject.prototype.iconify=function(fixture,styles){var canvas,container,render,size,_ref;if(typeof fixture!=="function"){fixture=$.uml.icon["."+fixture]||$.uml.icon[".actor"]}canvas=$("<canvas>").addClass("icon");container=$("<div>").addClass("icon-container");this.addClass("iconified").prepend(container.append(canvas));_ref=fixture(canvas[0],styles),size=_ref.size,styles=_ref.styles;container.css({width:size.width,height:size.height});render=__bind(function(){var name;name=this.find(".name");styles.fillStyle=name.css("background-color");styles.strokeStyle=name.css("border-top-color");return fixture(canvas[0],styles)},this);this.renderIcon=function(){return render()};return this};JUMLYObject.prototype.lost=function(){return this.activate().interact(null,{stereotype:".lost"})};uml.def(".object",JUMLYObject);JUMLYRelationship=(function(){function JUMLYRelationship(props,opts){this.src=opts.source;this.dst=opts.destination;jQuery.extend(this,JUMLYRelationship.newNode());this}JUMLYRelationship.newNode=function(){return $("<div>").addClass("relationship").append($("<canvas>").addClass("icon")).append($("<div>").addClass("name"))};return JUMLYRelationship})();MESSAGE_STYLE={width:1,base:6,height:10,lineWidth:1.5,shape:"dashed",pattern:[8,8],strokeStyle:"gray",fillStyle:"gray",lineJoin:"round"};Math.sign=function(x){if(x===0){return 0}else{if(x>0){return 1}}return -1};JUMLYRelationship.prototype.render=function(){var aa,bb,cc,cr,ctxt,dd,dsticon,expand,margin,margin_left,margin_top,p,pt,q,r,rect,s,srcicon,style,t;margin_left=$("body").cssAsInt("margin-left");margin_top=$("body").cssAsInt("margin-top");pt=function(obj){var dh,dv,p,s;s=obj.offset();dh=0*(obj.cssAsInt("margin-left"))-margin_left;dv=0*obj.css("margin-top").toInt()-margin_top;return p={left:s.left+obj.outerWidth()/2+dh,top:s.top+obj.outerHeight()/2+dv}};rect=function(p,q){var a,b,h,hs,l,r,vs,w;a={left:Math.min(p.left,q.left),top:Math.min(p.top,q.top)};b={left:Math.max(p.left,q.left),top:Math.max(p.top,q.top)};w=b.left-a.left+1;h=b.top-a.top+1;hs=Math.sign(q.left-p.left);vs=Math.sign(q.top-p.top);l=Math.sqrt(w*w+h*h);return r={left:a.left,top:a.top,width:w,height:h,hsign:hs,vsign:vs,hunit:hs*w/l,vunit:vs*h/l}};expand=function(rect,val){var d,r;if(typeof val==="number"){return expand(rect,{left:val,top:val,right:val,bottom:val})}r=$.extend({},rect);for(d in val){switch(d){case"left":r.left-=val[d];r.width+=val[d];break;case"top":r.top-=val[d];r.height+=val[d];break;case"right":r.width+=val[d];break;case"bottom":r.height+=val[d]}}return r};srcicon=this.src.find(".icon");dsticon=this.dst.find(".icon");p=pt(srcicon);q=pt(dsticon);r=rect(p,q);cr=2;aa=r.hunit*dsticon.outerWidth()/cr;bb=r.vunit*dsticon.outerHeight()/cr;cc=r.hunit*srcicon.outerWidth()/cr;dd=r.vunit*srcicon.outerHeight()/cr;s={x:p.left-r.left+cc,y:p.top-r.top+dd};t={x:q.left-r.left-aa,y:q.top-r.top-bb};margin=4;r=expand(r,margin);this.width(r.width);this.height(r.height);this.offset({left:r.left,top:r.top});ctxt=this.find("canvas").css({width:r.width,height:r.height}).attr({width:r.width,height:r.height})[0].getContext("2d");ctxt.save();ctxt.translate(margin,margin);style=$.extend({},MESSAGE_STYLE,{pattern:[4,4],shape:"line"});if(this.hasClass("extend")){style=$.extend(style,{shape:"dashed"})}$.g2d.arrow(ctxt,s,t,style);return ctxt.restore()};$.uml.def(".relationship",JUMLYRelationship);_STYLES={radius:14,lineWidth:1.5,fillStyle:"white",strokeStyle:"gray",shadowBlur:4,shadowColor:"rgba(0,0,0,0.33)",shadowOffsetX:10,shadowOffsetY:5};consts={ACTOR_HEAD:8,VIEW_RADIUS:14,CONTROLLER_RADIUS:14,ENTITY_RADIUS:14};_path=$.g2d.path;_actor_renderer=function(ctxt,styles){var exth,lw,r,r0,r1,r2,ret;r=styles.radius*0.66||consts.ACTOR_HEAD;r2=r*2;exth=r*0.25;lw=Math.round(styles.lineWidth);r0=function(){ctxt.arc(lw+r,lw+r,r,0,Math.PI*2,true);ctxt.fill();ctxt.shadowColor="transparent";return ctxt.stroke()};r1=function(){var dh,dv;dh=3*lw;dv=r2*0.85;new _path(ctxt).moveTo(0,r2+lw+exth).line(lw+r2+lw,0).moveTo(lw+r,r2+lw).line(0,r2*0.35).line(-r2+dh,dv).move(r2-dh,-dv).line(r2-dh-1,dv-1);ctxt.shadowColor=styles.shadowColor;return ctxt.stroke()};return ret={size:{width:lw+r2+lw,height:lw+r2*2+lw},paths:[r0,r1]}};_view_renderer=function(ctxt,styles){var extw,lw,r,r0,r1,r2,ret;r=styles.radius||consts.VIEW_RADIUS;r2=r*2;extw=r*0.4;lw=styles.lineWidth;r0=function(){ctxt.arc(lw+r+extw,lw+r,r,0,Math.PI*2,true);ctxt.fill();ctxt.shadowColor="transparent";return ctxt.stroke()};r1=function(){new _path(ctxt).moveTo(lw,r).line(extw,0).moveTo(lw,0).line(0,r2);return ctxt.stroke()};return ret={size:{width:lw+r2+extw+lw,height:lw+r2+lw},paths:[r0,r1]}};_controller_renderer=function(ctxt,styles){var dy,effectext,exth,lh,lw,r,r0,r1,r2,ret;r=styles.radius||consts.CONTROLLER_RADIUS;r2=r*2;exth=r*0.4;lw=lh=styles.lineWidth;dy=0;effectext=0;r0=function(){ctxt.arc(lw+r,lw+r+exth,r,0,Math.PI*2,true);ctxt.fill();ctxt.shadowColor="transparent";return ctxt.stroke()};r1=function(){new _path(ctxt).moveTo(lw+r,lh+exth).lineTo(lw+r*1.4,lh+exth/4).moveTo(lw+r,lh+exth).lineTo(lw+r*1.4,lh+exth*7/4);return ctxt.stroke()};return ret={size:{width:lw+r2+lw+effectext,height:lw+r2+lw+effectext+exth},paths:[r0,r1]}};_entity_renderer=function(ctxt,styles){var exth,lw,r,r0,r1,r2,ret;r=styles.radius||consts.ENTITY_RADIUS;r2=r*2;exth=r*0.4;lw=styles.lineWidth;r0=function(){ctxt.arc(lw+r,lw+r,r,0,Math.PI*2,true);ctxt.fill();ctxt.shadowColor="transparent";return ctxt.stroke()};r1=function(){ctxt.shadowColor=styles.shadowColor;new _path(ctxt).moveTo(lw+r,r2).lineTo(lw+r,r2+exth).moveTo(0,r2+exth).lineTo(r2+lw,r2+exth);return ctxt.stroke()};return ret={size:{width:lw+r2+lw,height:lw+r2+exth+lw},paths:[r0,r1]}};_size_canvas=function(canvas,size,styles){var dh,dw;dw=styles.shadowOffsetX+styles.shadowBlur||0;dh=styles.shadowOffsetY+styles.shadowBlur||0;$(canvas).attr({width:size.width+dw,height:size.height+dh});return size};_render_icon=function(canvas,renderer,args){var ctxt,e,paths,r,size,styles,_i,_len,_ref;args=args||{};styles=$.extend(_STYLES,args);ctxt=canvas.getContext("2d");_ref=renderer(ctxt,styles),size=_ref.size,paths=_ref.paths;_size_canvas(canvas,size,styles);$.extend(ctxt,styles);for(_i=0,_len=paths.length;_i<_len;_i++){e=paths[_i];ctxt.beginPath();e()}return r={size:size,styles:styles}};_render_actor=function(canvas,styles){return _render_icon(canvas,_actor_renderer,styles)};_render_view=function(canvas,styles){return _render_icon(canvas,_view_renderer,styles)};_render_controller=function(canvas,styles){return _render_icon(canvas,_controller_renderer,styles)};_render_entity=function(canvas,args){return _render_icon(canvas,_entity_renderer,args)};if((_ref=(_base=$.uml).icon)==null){_base.icon={}}$.extend($.uml.icon,{".actor":_render_actor,".view":_render_view,".controller":_render_controller,".entity":_render_entity});JUMLYNote=(function(){__extends(JUMLYNote,JUMLY.HTMLElement);function JUMLYNote(){JUMLYNote.__super__.constructor.apply(this,arguments)}return JUMLYNote})();JUMLYNote.prototype._build_=function(div,a){return div.addClass("note").append($("<div>").addClass("inner").append($("<div>").addClass("content").html(a)))};jQuery.uml.def(".note",JUMLYNote)}).call(this);(function(){var JUMLYUsecaseDiagram,JUMLYUsecaseDiagramBuilder,UMLActor,UMLSystemBoundary,UMLUsecase,bind_between,set_min_size,shift_usecase_down_to_above;var __hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};UMLUsecase=(function(){function UMLUsecase(props,opts){jQuery.extend(this,UMLUsecase.newNode());this}UMLUsecase.newNode=function(){return $("<div>").addClass("usecase").append($("<div>").addClass("icon").append($("<div>").addClass("name")))};return UMLUsecase})();UMLUsecase.prototype.pack=function(T){var R,h,icon,minheight,minwidth,name,t,v;if(T==null){T=(1+2.2360679)/2}icon=this.find(".icon");name=this.find(".icon .name");minwidth=icon.css("min-width").toInt();minheight=icon.css("min-height").toInt();R=minwidth/minheight;h=icon.height();v=name.height();t=h/v;if(t>T){t=T}return icon.css({width:minwidth*t,height:minheight*t})};$.uml.def(".usecase",UMLUsecase);UMLActor=(function(){function UMLActor(props,opts){jQuery.extend(this,$.uml(".object"));this.iconify(".actor");this.addClass("actor");this}return UMLActor})();$.uml.def(".actor",UMLActor);UMLSystemBoundary=(function(){function UMLSystemBoundary(props,opts){jQuery.extend(this,UMLSystemBoundary.newNode());this}UMLSystemBoundary.newNode=function(){return $("<div>").addClass("system-boundary").append($("<div>").addClass("name"))};return UMLSystemBoundary})();$.uml.def(".system-boundary",UMLSystemBoundary);JUMLYUsecaseDiagram=(function(){__extends(JUMLYUsecaseDiagram,JUMLY.Diagram);function JUMLYUsecaseDiagram(){JUMLYUsecaseDiagram.__super__.constructor.apply(this,arguments)}return JUMLYUsecaseDiagram})();set_min_size=function(nodes){return nodes.each(function(i,e){var h,w;e=$(e);if(w=e.css("min-width")){e.width(w).css({width:w})}if(h=e.css("min-height")){return e.height(h).css({height:h})}})};shift_usecase_down_to_above=function(nodes){return nodes.each(function(i,e){return $(e).find("> .usecase .icon").each(function(i,e){e=$(e);if(i>0){return e.css("margin-top",-e.css("min-height").toInt()/3)}})})};bind_between=function(nodes,diag){return nodes.each(function(i,e){var bind,find_with_id,src;src=$(e).self();find_with_id=function(id){var t;if(diag[id]){return diag[id]}if(!((typeof id==="string")||(typeof id==="number"))){return id}if((t=$("#"+id,diag)).length>0){return t}};bind=function(type){return $(src.data("uml:property")[type]).each(function(i,e){var dst,link;if(!(dst=find_with_id(e))){return}link=$.uml(".relationship",{source:src,destination:dst});link.addClass(type);return diag.append(link)})};bind("use");bind("extend");return bind("include")})};JUMLYUsecaseDiagram.prototype.align_actors_=function(){var actors,dh,height,tb;tb=this.find(".system-boundary").mostTopBottom();height=tb.height();actors=this.find(".actor");dh=height/actors.length;return actors.each(function(i,e){var dy,y;dy=i>1?(i%2===0?dh:-dh):0;y=tb.top+dy+height/2;return $(e).offset({top:y})})};JUMLYUsecaseDiagram.prototype.render=function(){return this.find(".relationship").each(function(i,e){return $(e).self().render()})};JUMLYUsecaseDiagram.prototype.compose=function(){this.trigger("beforeCompose",[this]);set_min_size(this.find(".usecase .icon"));shift_usecase_down_to_above(this.find(".system-boundary"));bind_between(this.find(".usecase, .actor"),this);this.align_actors_();this.render();this.height(this.mostTopBottom().height());this.trigger("afterCompose",[this]);return this};$.uml.def(".usecase-diagram",JUMLYUsecaseDiagram);JUMLYUsecaseDiagramBuilder=(function(){__extends(JUMLYUsecaseDiagramBuilder,JUMLY.DiagramBuilder);function JUMLYUsecaseDiagramBuilder(_diagram,_boundary){this._diagram=_diagram;this._boundary=_boundary}return JUMLYUsecaseDiagramBuilder})();JUMLYUsecaseDiagramBuilder.prototype.new_=function(type,uname){var a;uname=$.jumly.normalize(uname);a=$.uml(type,uname);$.extend(a.data("uml:property"),uname);return a};JUMLYUsecaseDiagramBuilder.prototype._declare_=function(uname,type,target){var a,b,ref;a=this.new_(type,uname);target.append(a);b=JUMLY.Identity.normalize(uname);ref=this._diagram._regByRef_(b.id,a);return eval(""+ref+" = a")};JUMLYUsecaseDiagramBuilder.prototype.usecase=function(uname){return this._declare_(uname,".usecase",this._boundary)};JUMLYUsecaseDiagramBuilder.prototype.actor=function(uname){return this._declare_(uname,".actor",this._diagram)};JUMLYUsecaseDiagramBuilder.prototype.boundary=function(name,acts){var boundary,ctxt,id,norm;if(!this._diagram){this._diagram=this.diagram}if(name==null){name=""}if(id=$.jumly.identify(name)){return curry_(this,this.boundary,id)}boundary=this.new_(".system-boundary",name);ctxt=new JUMLYUsecaseDiagramBuilder(this._diagram,boundary);ctxt.diagram=this._diagram;acts.apply(ctxt);if(this._boundary){this._boundary.append(boundary)}else{this._diagram.append(boundary)}norm=JUMLY.Identity.normalize(name);this._diagram._regByRef_(norm.id);return this};JUMLYUsecaseDiagramBuilder.prototype.compose=function(something){if(typeof something==="function"){something(this._diagram)}else{if(typeof something==="object"&&something.each){something.append(this._diagram)}else{throw something+" MUST be a function or a jQuery object"}}this._diagram.compose();return this};JUMLYUsecaseDiagram.prototype.boundary=function(name,acts){var ctxt;ctxt=new JUMLYUsecaseDiagramBuilder(this);ctxt.boundary(name,acts);return ctxt};$.jumly.DSL({type:".usecase-diagram",compileScript:function(script){var diag,sbname;diag=$.jumly(".usecase-diagram");sbname=$(script).attr("system-boundary-name");diag.boundary(sbname,function(){if(!sbname){this._boundary.addClass("out-of-bounds").removeClass("system-boundary").find(".name").remove()}return eval(CoffeeScript.compile(script.html()))});return diag}});JUMLY.UsecaseDiagramBuilder=JUMLYUsecaseDiagramBuilder}).call(this);(function(){var JUMLYClass,JUMLYClassDiagram,JUMLYClassDiagramBuilder;var __hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};JUMLYClassDiagram=(function(){__extends(JUMLYClassDiagram,JUMLY.Diagram);function JUMLYClassDiagram(){JUMLYClassDiagram.__super__.constructor.apply(this,arguments)}return JUMLYClassDiagram})();JUMLYClassDiagram.prototype.member=function(kind,clz,normval){var holder;holder=clz.find("."+kind+"s");return $(normval[""+kind+"s"]).each(function(i,e){var id;id=""+normval.id+"-"+kind+"-"+e;if(holder.find("."+e).length>0){throw new Error("Already exists "+e)}return holder.append($("<li>").addClass(e).attr("id",id).html(e))})};JUMLYClassDiagram.prototype.declare=function(normval){var clz,kind,ref,_i,_len,_ref;clz=$.jumly(".class",normval);if(normval.stereotype){clz.find(".stereotype").html(normval.stereotype)}else{clz.find(".stereotype").hide()}_ref=["attr","method"];for(_i=0,_len=_ref.length;_i<_len;_i++){kind=_ref[_i];this.member(kind,clz,normval)}ref=this._regByRef_(normval.id,clz);eval(""+ref+" = clz");return this.append(clz)};JUMLYClassDiagram.prototype.preferredWidth=function(){return this.find(".class .icon").mostLeftRight().width()+16};JUMLYClassDiagram.prototype.preferredHeight=function(){return this.find(".class .icon").mostTopBottom().height()};JUMLYClassDiagram.prototype.compose=function(){this.trigger("beforeCompose",[this]);this.find(".class .icon").each(function(i,e){e=$(e);if(e.width()>e.height()){return null}return e.width(e.height()*(1+Math.sqrt(2))/2)});this.trigger("afterCompose",[this]);this.width(this.preferredWidth());this.height(this.preferredHeight());return this};JUMLYClass=(function(){__extends(JUMLYClass,JUMLY.HTMLElement);function JUMLYClass(){JUMLYClass.__super__.constructor.apply(this,arguments)}return JUMLYClass})();JUMLYClass.prototype._build_=function(div){var icon;icon=$("<div>").addClass("icon").append($("<div>").addClass("stereotype")).append($("<div>").addClass("name")).append($("<ul>").addClass("attrs")).append($("<ul>").addClass("methods"));return div.addClass("object").append(icon)};JUMLY.define(".class-diagram",JUMLYClassDiagram);JUMLY.define(".class",JUMLYClass);JUMLYClassDiagramBuilder=(function(){__extends(JUMLYClassDiagramBuilder,JUMLY.DiagramBuilder);function JUMLYClassDiagramBuilder(diagram){this.diagram=diagram}return JUMLYClassDiagramBuilder})();JUMLYClassDiagramBuilder.prototype.def=function(props){return this.diagram.declare(JUMLY.Identity.normalize(props))};JUMLYClassDiagramBuilder.prototype.start=function(acts){return acts.apply(this,[])};$.jumly.DSL({type:".class-diagram",compileScript:function(script){var b;b=new JUMLYClassDiagramBuilder;return b.build(script.html())}});JUMLY.ClassDiagramBuilder=JUMLYClassDiagramBuilder}).call(this);(function(){var JUMLYFragment,JUMLYInteraction,JUMLYLifeline,JUMLYMessage,JUMLYOccurrence,JUMLYRef,JUMLYSequenceDiagram,JUMLYSequenceDiagramBuilder,MESSAGE_STYLE,STEREOTYPE_STYLES,SequenceDiagramLayout,jumly,prefs_,_determine_primary_stereotype;var __hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};JUMLYMessage=(function(){__extends(JUMLYMessage,JUMLY.HTMLElement);function JUMLYMessage(){JUMLYMessage.__super__.constructor.apply(this,arguments)}return JUMLYMessage})();JUMLYInteraction=(function(){__extends(JUMLYInteraction,JUMLY.HTMLElement);function JUMLYInteraction(){JUMLYInteraction.__super__.constructor.apply(this,arguments)}return JUMLYInteraction})();JUMLYLifeline=(function(){__extends(JUMLYLifeline,JUMLY.HTMLElement);function JUMLYLifeline(){JUMLYLifeline.__super__.constructor.apply(this,arguments)}return JUMLYLifeline})();JUMLYOccurrence=(function(){__extends(JUMLYOccurrence,JUMLY.HTMLElement);function JUMLYOccurrence(){JUMLYOccurrence.__super__.constructor.apply(this,arguments)}return JUMLYOccurrence})();JUMLYFragment=(function(){__extends(JUMLYFragment,JUMLY.HTMLElement);function JUMLYFragment(){JUMLYFragment.__super__.constructor.apply(this,arguments)}return JUMLYFragment})();JUMLYSequenceDiagram=(function(){__extends(JUMLYSequenceDiagram,JUMLY.Diagram);function JUMLYSequenceDiagram(){JUMLYSequenceDiagram.__super__.constructor.apply(this,arguments)}return JUMLYSequenceDiagram})();JUMLYRef=(function(){__extends(JUMLYRef,JUMLY.HTMLElement);function JUMLYRef(){JUMLYRef.__super__.constructor.apply(this,arguments)}return JUMLYRef})();jumly=$.jumly;jumly.def(".message",JUMLYMessage);jumly.def(".interaction",JUMLYInteraction);jumly.def(".lifeline",JUMLYLifeline);jumly.def(".occurrence",JUMLYOccurrence);jumly.def(".fragment",JUMLYFragment);jumly.def(".ref",JUMLYRef);jumly.def(".sequence-diagram",JUMLYSequenceDiagram);JUMLYMessage.prototype._build_=function(div){return div.append($("<canvas>").addClass("arrow")).append($("<div>").addClass("name"))};JUMLYMessage.prototype.to_line=function(canvas){return this._lineToNextOccurr(canvas)};JUMLYMessage.prototype._lineToNextOccurr=function(canvas){var dstll,srcll;if(false){console.log("FIXME: to avoid runtime error.");({src:{x:0,y:0},dst:{x:400,y:0}})}srcll=this._src_occurr();dstll=this._dst_occurr();return this._to_line(srcll,dstll,canvas)};JUMLYMessage.prototype._to_line=function(srcll,dstll,canvas){if(!this.parent().hasClass("lost")&&this.isTowardLeft()){return{src:{x:srcll.offset().left-this.offset().left,y:canvas.outerHeight()/2},dst:{x:dstll.outerWidth(),y:canvas.outerHeight()/2}}}else{return{src:{x:srcll.outerWidth(),y:canvas.outerHeight()/2},dst:{x:dstll.offset().left-srcll.offset().left,y:canvas.outerHeight()/2}}}};JUMLYMessage.prototype._src_occurr=function(){return this.parents(".occurrence:eq(0)").self()};JUMLYMessage.prototype._dst_occurr=function(){return(this.hasClass("return")?this.prev(".occurrence"):$("~ .occurrence",this)).self()};JUMLYMessage.prototype._prefferedCanvas=function(){return this.find("canvas:eq(0)").attr({width:this.width(),height:this.height()}).css({width:this.width(),height:this.height()})};JUMLYMessage.prototype._to_create_line=function(canvas){var e,src;e=this._to_line(this._src_occurr(),this._dst_occurr().gives(".object"),canvas);if(this.isTowardLeft()){src=this._src_occurr();e.dst.x=src.gives(".object").outerRight()-src.offset().left}return e};JUMLYMessage.prototype._findOccurr=function(actee){var occurr;occurr=null;this.parents(".occurrence").each(__bind(function(i,e){e=$(e).self();if(e.gives(".object")===actee){return occurr=e}},this));return occurr};MESSAGE_STYLE={width:1,base:6,height:10,lineWidth:1.5,shape:"line2",pattern:[8,8],strokeStyle:"gray",fillStyle:"gray"};STEREOTYPE_STYLES={create:{shape:"dashed"},asynchronous:{shape:"line"},synchronous:{shape:"line2",fillStyle:"gray"},destroy:{shape:"line2",fillStyle:"gray"}};_determine_primary_stereotype=function(jqnode){var e,_i,_len,_ref;_ref=["create","asynchronous","synchronous","destroy"];for(_i=0,_len=_ref.length;_i<_len;_i++){e=_ref[_i];if(jqnode.hasClass(e)){return e}}};JUMLYMessage.prototype.repaint=function(style){var a,arrow,canvas,ctxt,gap,line,llw,newdst,newsrc,p,rcx,rey;arrow=jQuery.extend({},MESSAGE_STYLE,style,STEREOTYPE_STYLES[_determine_primary_stereotype(this)]);canvas=this._current_canvas=this._prefferedCanvas();if(style!=null?style.inherit:void 0){p=this.parents(".occurrence:eq(0)");arrow.fillStyle=p.css("background-color");arrow.strokeStyle=p.css("border-top-color");(p.css("box-shadow")).match(/(rgba\(.*\)) ([0-9]+)px ([0-9]+)px ([0-9]+)px ([0-9]+)px/);arrow.shadowColor=RegExp.$1;arrow.shadowOffsetX=RegExp.$2;arrow.shadowOffsetY=RegExp.$3;arrow.shadowBlur=RegExp.$4}if(arrow.self){ctxt=canvas[0].getContext("2d");gap=2;rcx=this.width()-(gap+4);rey=this.height()-(arrow.height/2+4);llw=this._dst_occurr().outerWidth();$.g2d.arrow(ctxt,{x:rcx,y:rey},{x:llw+gap,y:rey},arrow);arrow.base=0;$.g2d.arrow(ctxt,{x:llw/2+gap,y:gap},{x:rcx,y:gap},arrow);$.g2d.arrow(ctxt,{x:rcx,y:gap},{x:rcx,y:rey},arrow);return this}if(this.hasClass("create")){line=this._to_create_line(canvas)}else{if(this.gives(".actee")){newsrc=this._findOccurr(this.gives(".actee"));newdst=this._dst_occurr();line=this._to_line(newsrc,newdst,canvas)}else{line=this._lineToNextOccurr(canvas)}}if(arrow.reverse){a=line.src;line.src=line.dst;line.dst=a;arrow.shape="dashed"}jQuery.g2d.arrow(canvas[0].getContext("2d"),line.src,line.dst,arrow);return this};JUMLYMessage.prototype.isToward=function(dir){var actee,actor,iact,see;iact=this.gives(".interaction");see=function(a){return iact.gives(".occurrence").as(a).gives(".object")};actor=see(".actor");actee=see(".actee");if("right"===dir){return actor.isLeftAt(actee)}else{if("left"===dir){return actor.isRightAt(actee)}}};JUMLYMessage.prototype.isTowardRight=function(){return this.isToward("right")};JUMLYMessage.prototype.isTowardLeft=function(){return this.isToward("left")};JUMLYMessage.prototype._composeLooksOfCreation=function(){var centering_name,created,dstoccur,preffered_width,render,shift_down_lifeline,shift_downward,srcoccur,w;srcoccur=this._src_occurr();dstoccur=this._dst_occurr();render=function(msg){return msg.repaint().gives(".interaction").gives(".occurrence").as(".actee")};preffered_width=function(msg){var l;l=msg._to_line(srcoccur,dstoccur.gives(".object"),msg);return Math.abs(l.src.x-l.dst.x)};centering_name=function(msg,newwidth){var newleft;if(msg.isTowardLeft()){return}newleft=srcoccur.outerWidth()+msg.offset().left+(newwidth-msg.find(".name").outerWidth())/2;return msg.find(".name").offset({left:newleft})};shift_down_lifeline=function(obj){var diag,ll,prevtop;diag=obj.parents(".sequence-diagram");ll=$(".lifeline .line:eq(1)",diag);prevtop=ll.offset().top;ll.offset({top:obj.offset().top+obj.outerHeight()});return ll.height(ll.height()-(ll.offset().top-prevtop))};shift_downward=function(msg){var dy,iact,y;created.offset({top:msg.offset().top-created.height()/3});y=created.outerBottom()+parseInt(dstoccur.css("margin-top"));dstoccur.offset({top:y});iact=msg.parents(".interaction:eq(0)");dy=iact.outerBottom()-dstoccur.outerBottom()-parseInt(dstoccur.css("margin-top"));return iact.css("margin-bottom",Math.abs(dy))};created=dstoccur.gives(".object");w=preffered_width(this);shift_downward(this);render(this);centering_name(this,w);return shift_down_lifeline(created)};JUMLYInteraction.prototype._build_=function(div,props){var msg;msg=jumly({type:".message",".interaction":this});props[".message"]=msg;return div.append(msg)};JUMLYInteraction.prototype.interact=function(obj){return this.awayfrom().interact(obj)};JUMLYInteraction.prototype.forward=function(obj){return this.toward()};JUMLYInteraction.prototype.to=function(func){var occurrs,tee,tor;occurrs=this.gives(".occurrence");tee=occurrs.as(".actee");tor=occurrs.as(".actor");return func(tee,tor)};JUMLYInteraction.prototype.forwardTo=function(){return this.gives(".occurrence").as(".actee")};JUMLYInteraction.prototype.backwardTo=function(){return this.gives(".occurrence").as(".actor")};JUMLYInteraction.prototype.toward=function(){return this.forwardTo()};JUMLYInteraction.prototype.awayfrom=function(obj){var e,_i,_len,_ref;if(!obj){return this.backwardTo()}_ref=this.parents(".occurrence").not(".activated");for(_i=0,_len=_ref.length;_i<_len;_i++){e=_ref[_i];e=$(e).self();if((e!=null?e.gives(".object"):void 0)===obj){return e}}return obj.activate()};JUMLYInteraction.prototype._compose_=function(){var actee,dst,msg,newdst,rmsg,src,that,w,x;that=this;src=that.gives(".occurrence").as(".actor");dst=that.gives(".occurrence").as(".actee");msg=jumly($("> .message",that))[0];if(this.isToSelf()){this._buildSelfInvocation(src,dst,msg);return}w=src.offset().left-(dst.offset().left+$(".occurrence:eq(0)",that).width());if(this.hasClass("lost")){msg.height(dst.outerHeight())}else{if(msg.isTowardLeft()){w=dst.offset().left-(src.offset().left+$(".occurrence:eq(0)",that).width())}}msg.width(Math.abs(w)).offset({left:Math.min(src.offset().left,dst.offset().left)}).repaint();rmsg=$("> .message.return:last",that).self();if(rmsg){x=msg.offset().left;actee=rmsg.gives(".actee");if(actee){newdst=rmsg._findOccurr(actee);if(!newdst){console.error("Not found occurrence for",actee);throw new Error("Not found occurrence "+(actee.html()))}w=dst.offset().left-newdst.offset().left;x=Math.min(dst.offset().left,newdst.offset().left)}return rmsg.width(Math.abs(w)).offset({left:x}).repaint({reverse:true})}};JUMLYInteraction.prototype._buildSelfInvocation=function(a,b,msg){var arrow,dx,dy,w;w=this.find(".occurrence:eq(0)").outerWidth();dx=w*2;dy=w*1;b.css({top:0+dy});this.css({"padding-bottom":dy});msg.css({top:0}).width(b.width()+dx).height(b.offset().top-msg.offset().top+dy+w/8).offset({left:b.offset().left});msg.repaint({self:true});arrow=msg.find(".arrow");return msg.find(".name").offset({left:arrow.offset().left+arrow.outerWidth(),top:arrow.offset().top})};JUMLYInteraction.prototype.reply=function(p){var a;this.addClass("reply");a=jumly({type:".message",".interaction":this,".actee":p!=null?p[".actee"]:void 0}).addClass("return").insertAfter(this.children(".occurrence:eq(0)"));if(p!=null?p.name:void 0){a.name(p.name)}return this};JUMLYInteraction.prototype.fragment=function(attrs,opts){var frag;frag=jumly({type:".fragment"});return frag.enclose(this)};JUMLYInteraction.prototype.isToSelf=function(){var a,b;a=this.gives(".occurrence").as(".actor");b=this.gives(".occurrence").as(".actee");if(!(a&&b)){return false}return a.gives(".object")===b.gives(".object")};JUMLYInteraction.prototype.is_to_itself=function(){return this.isToSelf()};JUMLYLifeline.prototype._build_=function(div,props){return div.append($("<div>").addClass("line").height(128)).width(props[".object"].width()).height(128)};JUMLYOccurrence.prototype.interact=function(_,opts){var alt,iact,occurr,_as;_as=jumly.lang._as;if((opts!=null?opts.stereotype:void 0)===".lost"){occurr=jumly({type:".occurrence"}).addClass("icon");iact=jumly({type:".interaction",".occurrence":_as({".actor":this,".actee":occurr}),".actor":this,".actee":occurr});iact.addClass("lost")}else{if((opts!=null?opts.stereotype:void 0)===".destroy"){}else{if((_!=null?_.stereotype:void 0)===".alt"){alt=jumly(".fragment",{name:"alt"});alt.alter(this,opts);return this}else{occurr=jumly({type:".occurrence",".object":_});iact=jumly({type:".interaction",".occurrence":_as({".actor":this,".actee":occurr}),".object":_as({".actor":this.gives(".object"),".actee":_}),".actor":this,".actee":occurr})}}}iact.append(occurr).appendTo(this);return iact};JUMLYOccurrence.prototype.create=function(objsrc){var iact,obj;obj=jumly(".object",objsrc.name);obj.attr("id",objsrc.id);this.parents(".sequence-diagram").self()[JUMLY.Naming.toRef(objsrc.id)]=obj;this.gives(".object").parent().append(obj);iact=(this.interact(obj)).stereotype("create");return iact};JUMLYOccurrence.prototype.moveHorizontally=function(){var left;if(this.parent().hasClass("lost")){this.offset({left:this.parents(".diagram").find(".object").mostLeftRight().right});return this}if(!this.isOnOccurrence()){left=this.gives(".object").offset().left+(this.gives(".object").width()-this.width())/2}else{left=this.parentOccurrence().offset().left}left+=this.width()*this.shiftToParent()/2;return this.offset({left:left})};JUMLYOccurrence.prototype.isOnOccurrence=function(){return !(this.parentOccurrence()===null)};JUMLYOccurrence.prototype.parentOccurrence=function(){var i,lls,_ref;lls=jumly(this.parents(".occurrence"));if(lls.length===0){return null}for(i=0,_ref=lls.length-1;0<=_ref?i<=_ref:i>=_ref;0<=_ref?i++:i--){if(this.gives(".object")===lls[i].gives(".object")){return lls[i]}}return null};JUMLYOccurrence.prototype.shiftToParent=function(){var a;if(!this.isOnOccurrence()){return 0}a=jumly(this.parent().find(".message:eq(0)"))[0];if(a===void 0){return 0}if(a.isTowardRight()){return -1}if(a.isTowardLeft()){return 1}return 1};JUMLYOccurrence.prototype.preceding=function(obj){var f;f=function(ll){var a;a=jumly(ll.parents(".occurrence:eq(0)"))[0];if(!a){return null}if(a.gives(".object")===obj){return a}return f(a)};return f(this)};JUMLYOccurrence.prototype.destroy=function(actee){var occur;occur=this.interact(actee).stereotype("destroy").gives(".occurrence").as(".actee");if(occur.isOnOccurrence()){occur=occur.parentOccurrence()}$("<div>").addClass("stop").append($("<div>").addClass("icon").addClass("square").addClass("cross")).insertAfter(occur);return occur};JUMLYFragment.prototype._build_=function(div){return div.append($("<div>").addClass("header").append($("<div>").addClass("name")).append($("<div>").addClass("condition")))};JUMLYFragment.prototype.enclose=function(_){var a,b,i,_ref;if(!(_!=null)||_.length===0){throw"JUMLYFragment::enclose arguments are empty."}if(_.length>1){a=$(_[0]).parent()[0];for(i=1,_ref=_.length-1;1<=_ref?i<=_ref:i>=_ref;1<=_ref?i++:i--){b=$(_[i]).parent()[0];if(a!==b){throw {message:"different parent",nodes:[a,b]}}}}if(_.parent===void 0){return this}this.swallow(_);return this};JUMLYFragment.prototype.extendWidth=function(opts){var dlw,drw,frag;frag=this;dlw=opts!=null?opts.left:void 0;drw=opts!=null?opts.right:void 0;if(dlw==null){dlw=0}if(drw==null){drw=0}frag.css("position","relative").css("left",-dlw).width(frag.width()+dlw/2).find("> .interaction").css("margin-left",dlw);return frag.width(frag.outerWidth()+drw)};JUMLYFragment.prototype.alter=function(occurr,opts){var act,alt,iact,name;alt=this;alt.addClass("alt").find(".condition").remove();occurr.append(alt);for(name in opts){act=opts[name];if(typeof act!=="function"){throw""+name+" is not function"}iact=act(occurr);if(iact===null||iact===void 0){break}if(!iact){throw""+iact+" of "+name+"'s action returned is not appendable into .alt.fragment"}alt.append($("<div>").addClass("condition").html(name)).append(iact).append($("<div>").addClass("divider"))}alt.find(".divider:last").remove();return alt};JUMLYRef.prototype._build_=function(div){return div.append($("<div>").addClass("header").append($("<div>").addClass("tag").html("ref"))).append($("<div>").addClass("name"))};JUMLYRef.prototype.preferredWidth=function(){var dh,diag,iact,lines,most,occurs;diag=this.parents(".sequence-diagram:eq(0)");iact=this.prevAll(".interaction:eq(0)");if(iact.length===0){lines=$(".lifeline .line",diag);most=lines.mostLeftRight();most.width=most.width();return most}dh=diag.self().find(".occurrence:eq(0)").width();occurs=iact.find(".occurrence");most=occurs.mostLeftRight();most.left-=dh;most.width=most.width();return most};JUMLYSequenceDiagram.prototype.gives=function(query){var e,f;e=this.find(query);f=jumly.lang._of(e,query);return{of:f}};prefs_={compose_most_left:0,compose_span:150-(88+4),WIDTH:null,HEIGHT:50};jumly.preferences(".sequence-diagram",prefs_);jumly.preferences(".sequence-diagram:system-default",prefs_);JUMLYSequenceDiagram.prototype.$=function(sel){return jumly($(sel,this))};JUMLYSequenceDiagram.prototype.$0=function(typesel){return this.$(typesel)[0]};JUMLYSequenceDiagram.prototype.preferences=function(a,b){var prefs,r,width;prefs=this.data("uml:property").preferences;if(!prefs){this.data("uml:property").preferences=prefs={}}width=function(){var left,objs,right;objs=$(".object",this);left=objs.min(function(e){return $(e).position().left})-this.position().left;right=objs.max(function(e){return $(e).position().left+$(e).outerWidth()})-this.position().left;return left+(right-left)+left};if((!b&&typeof a==="string")||(!a&&!b)){r=$.extend({},jumly.preferences(".sequence-diagram"),prefs);r.WIDTH=width.apply(this);return r}return $.extend(prefs,a)};JUMLYSequenceDiagram.prototype.compose=function(props){var causemsg;try{this.trigger("beforeCompose",[this]);(new SequenceDiagramLayout).layout(this);this.trigger("afterCompose",[this]);return this}catch(ex){causemsg=(function(){switch(ex.type){case"non_object_property_load":return"It may be not loaded completely for DOM tree.\n"}})();console.error("JUMLY caught an exception: "+causemsg,ex.stack,"\n",ex,{arguments:ex.arguments,stack:ex.stack,type:ex.type,message:ex.message,name:ex.name});throw ex}};SequenceDiagramLayout=(function(){__extends(SequenceDiagramLayout,JUMLY.DiagramLayout);function SequenceDiagramLayout(){SequenceDiagramLayout.__super__.constructor.apply(this,arguments)}return SequenceDiagramLayout})();SequenceDiagramLayout.prototype._layout_=function(){this.align_objects_horizontally();this.align_occurrences_horizontally();this.compose_interactions();this.generate_lifelines_and_align_horizontally();this.pack_object_lane_vertically();this.pack_refs_horizontally();this.pack_fragments_horizontally();this.align_creation_message_horizontally();this.align_lifelines_vertically();this.align_lifelines_stop_horizontally();this.rebuild_asynchronous_self_calling();this.render_icons();return this.diagram.width(this.diagram.preferredWidth())};SequenceDiagramLayout.prototype.align_objects_horizontally=function(){var f0,f1;f0=__bind(function(a){if(a.css("left")==="auto"){return a.css({left:this.prefs.compose_most_left})}},this);f1=__bind(function(a,b){var l;if(b.css("left")==="auto"){l=a.position().left+a.outerWidth()+this.prefs.compose_span;return b.css({left:l})}},this);return this._q(".object").pickup2(f0,f1)};SequenceDiagramLayout.prototype.align_occurrences_horizontally=function(){return this._q(".occurrence").selfEach(function(e){return e.moveHorizontally()})};SequenceDiagramLayout.prototype.compose_interactions=function(){return this._q(".occurrence .interaction").selfEach(function(e){return e._compose_()})};SequenceDiagramLayout.prototype.generate_lifelines_and_align_horizontally=function(){this._q(".lifeline").remove();return this._q(".object").selfEach(function(obj){var a;a=jumly({type:".lifeline",".object":obj});a.offset({left:obj.offset().left,top:obj.outerBottom()+1});return a.insertAfter(obj)})};SequenceDiagramLayout.prototype.pack_object_lane_vertically=function(){var mostheight,objs;if(this._q(".object-lane").length>0){return}objs=this._q(".object");mostheight=jQuery.max(objs,function(e){return $(e).outerHeight()});if(mostheight==null){mostheight=0}return $("<div>").addClass("object-lane").height(mostheight).swallow(objs)};SequenceDiagramLayout.prototype.pack_refs_horizontally=function(){var refs;refs=this._q(".ref");if(refs.length===0){return}return $(refs).selfEach(function(ref){var pw;pw=ref.preferredWidth();return ref.offset({left:pw.left}).width(pw.width)})};SequenceDiagramLayout.prototype.pack_fragments_horizontally=function(){var fixwidth,fragments,left,most;fragments=$("> .fragment",this.diagram);if(fragments.length>0){most=this._q(".object").mostLeftRight();left=fragments.offset().left;fragments.width((most.right-left)+(most.left-left))}fixwidth=function(fragment){var msg;most=$(".occurrence, .message, .fragment",fragment).not(".return, .lost").mostLeftRight();fragment.width(most.width()-(fragment.outerWidth()-fragment.width()));msg=jumly(fragment.find("> .interaction > .message"))[0];if(msg!=null?msg.isTowardLeft():void 0){return fragment.offset({left:most.left}).find("> .interaction > .occurrence").each(function(i,occurr){occurr=jumly(occurr)[0];return occurr.moveHorizontally().prev().offset({left:occurr.offset().left})})}};return this._q(".occurrence > .fragment").selfEach(fixwidth).parents(".occurrence > .fragment").selfEach(fixwidth)};SequenceDiagramLayout.prototype.align_lifelines_vertically=function(){var mostbottom;mostbottom=this.diagram.find(".occurrence").not(".interaction.lost .occurrence").max(function(e){return $(e).outerBottom()});return this._q(".lifeline").selfEach(function(a){var h,obj,y;obj=a.gives(".object");y=obj.outerBottom()+1;a.offset({left:obj.offset().left,top:y});h=mostbottom-y+16;a.height(h);return a.find(".line").css({top:0}).height(h)})};SequenceDiagramLayout.prototype.align_lifelines_stop_horizontally=function(){return $(".stop",this.diagram).each(function(i,e){var occurr;e=$(e);occurr=e.prev(".occurrence");return e.offset({left:occurr.offset().left})})};SequenceDiagramLayout.prototype.align_creation_message_horizontally=function(){return this._q(".message.create").selfEach(function(e){return e._composeLooksOfCreation()})};SequenceDiagramLayout.prototype.rebuild_asynchronous_self_calling=function(){return this.diagram.find(".message.asynchronous").parents(".interaction:eq(0)").each(function(i,e){var iact,msg,occurr,prev;e=$(e).self();if(!e.isToSelf()){return}iact=e.addClass("activated").addClass("asynchronous");prev=iact.parents(".interaction:eq(0)");iact.insertAfter(prev);occurr=iact.css("padding-bottom",0).find("> .occurrence").self().moveHorizontally().css("top",0);msg=iact.find(".message").self();return msg.css("z-index",-1).offset({left:occurr.offset().left,top:prev.find(".occurrence").outerBottom()-msg.height()/3})})};SequenceDiagramLayout.prototype.render_icons=function(){return this._q(".object").selfEach(function(e){return typeof e.renderIcon==="function"?e.renderIcon():void 0})};JUMLYSequenceDiagram.prototype.preferredWidth=function(){var a,bw,left,nodes;bw=this.css("border-right-width").toInt()+this.css("border-left-width").toInt();nodes=$(".object, .ref, .fragment",this);if(nodes.length===0){return 0+bw}a=nodes.mostLeftRight();if(a.left===a.right){return 0+bw}left=nodes.choose((function(e){return $(e).cssLeft()}),(function(x,t){return x<t}));return a.right-a.left+bw+1};JUMLYSequenceDiagramBuilder=(function(){__extends(JUMLYSequenceDiagramBuilder,JUMLY.DiagramBuilder);function JUMLYSequenceDiagramBuilder(props,_diagram){this._diagram=_diagram;$.extend(this,props)}return JUMLYSequenceDiagramBuilder})();JUMLYSequenceDiagramBuilder.prototype._findOrCreate=function(e){var a,obj,r;a=JUMLY.Identity.normalize(e);r=JUMLY.Naming.toRef(a.id);if(this.diagram[r]){return this.diagram[r]}obj=jumly(".object",a);this.diagram._regByRef_(a.id,obj);this.diagram.append(obj);switch(typeof e){case"string":this.diagram._def_(r,obj);break;case"object":this.diagram._def_(JUMLY.Naming.toRef(a.id),obj);break;default:console.error("It must be string or object for",e);throw new Error("Unrecognized argument: "+e)}return obj};JUMLYSequenceDiagramBuilder.prototype._actor=function(){return this._currOccurr.gives(".object")};JUMLYSequenceDiagramBuilder.prototype.message=function(a,b,c){var actee,actname,callback,e,iact,msg,norm,occurr,stereotype;actname=a;if(typeof b==="function"||b===void 0){actee=this._actor();callback=b}else{if(typeof a==="string"&&typeof b==="string"){if(typeof c==="function"){actee=this._findOrCreate(b);callback=c}else{if(c===void 0){actee=this._findOrCreate(b);callback=null}}}else{if(typeof a==="object"&&typeof b==="string"){actee=this._findOrCreate(b);callback=c;for(e in a){switch(e){case"asynchronous":actname=a[e];stereotype="asynchronous"}}}else{if(typeof a==="string"&&typeof b==="object"){norm=JUMLY.Identity.normalize(b);actee=this._findOrCreate(norm);callback=c}else{msg="invalid arguments";console.error("JUMLYSequenceDiagramBuilder::message",msg,a,b,c);throw new Error(msg,a,b,c)}}}}iact=this._currOccurr.interact(actee);iact.name(actname).stereotype(stereotype);occurr=iact.gives(".actee");b=new JUMLYSequenceDiagramBuilder({diagram:this.diagram,_currOccurr:occurr});if(callback!=null){callback.apply(b,[])}return b};JUMLYSequenceDiagramBuilder.prototype.create=function(a,b,c){var actee,callback,ctxt,e,iact,id,name,norm,occurr;if(typeof a==="string"&&typeof b==="function"){name=null;actee=a;callback=b}else{if(typeof a==="string"&&typeof b==="string"&&typeof c==="function"){name=a;actee=b;callback=c}else{if(typeof a==="string"&&b===void 0){name=null;actee=a;callback=null}else{if(typeof a==="object"&&typeof b==="function"){e=JUMLY.Identity.normalize(a);actee=e.name;callback=b}}}}if(typeof a==="string"){id=JUMLY.Naming.toID(actee)}else{norm=JUMLY.Identity.normalize(a);id=norm.id;actee=norm.name}iact=this._currOccurr.create({id:id,name:actee});if(name){iact.name(name)}occurr=iact.gives(".actee");occurr.gives(".object").attr("id",id);ctxt=new JUMLYSequenceDiagramBuilder({diagram:this.diagram,_currOccurr:occurr});if(callback!=null){callback.apply(ctxt,[])}this._def_(id,occurr.gives(".object"));return ctxt};JUMLYSequenceDiagramBuilder.prototype._def_=function(varname,refobj){var ref;ref=JUMLY.Naming.toRef(varname);return this.diagram._def_(ref,refobj)};JUMLYSequenceDiagramBuilder.prototype.destroy=function(a){this._currOccurr.destroy(this._findOrCreate(a));return null};JUMLYSequenceDiagramBuilder.prototype.reply=function(a,b){var obj,ref;obj=b;if(typeof b==="string"){ref=JUMLY.Naming.toRef(JUMLY.Naming.toID(b));if(this.diagram[ref]){obj=this.diagram[ref]}}this._currOccurr.parents(".interaction:eq(0)").self().reply({name:a,".actee":obj});return null};JUMLYSequenceDiagramBuilder.prototype.ref=function(a){(jumly(".ref",a)).insertAfter(this._currOccurr.parents(".interaction:eq(0)"));return null};JUMLYSequenceDiagramBuilder.prototype.lost=function(a){this._currOccurr.lost();return null};JUMLYSequenceDiagramBuilder.prototype.loop=function(a,b,c){var frag,kids,last,newones;if(a.constructor===this.constructor){frag=a._currOccurr.parents(".interaction:eq(0)").self().fragment({name:"Loop"}).addClass("loop")}else{last=[].slice.apply(arguments).pop();if($.isFunction(last)){kids=this._currOccurr.find("> *");last.apply(this,[]);newones=this._currOccurr.find("> *").not(kids);if(newones.length>0){frag=jumly(".fragment").addClass("loop").enclose(newones);frag.find(".name:first").html("Loop")}}}return this};JUMLYSequenceDiagramBuilder.prototype.alt=function(ints,b,c){var act,iacts,name,self,_new_act;iacts={};self=this;for(name in ints){if(typeof ints[name]!=="function"){break}act=ints[name];_new_act=function(name,act){return function(){var what;what=act.apply(self);if(!what){return what}return what._currOccurr.parent(".interaction:eq(0)")}};iacts[name]=_new_act(name,act)}this._currOccurr.interact({stereotype:".alt"},iacts);return this};JUMLYSequenceDiagramBuilder.prototype.reactivate=function(a,b,c){var ctxt,e,occurr;if(a.constructor===this.constructor){e=a._currOccurr.parents(".interaction:eq(0)");this._actor().activate().append(e);return a}occurr=this._actor().activate();ctxt=new JUMLYSequenceDiagramBuilder({diagram:this.diagram,_currOccurr:occurr});ctxt.message(a,b,c);return ctxt};JUMLYSequenceDiagramBuilder.prototype._note=function(a,b,c){var nodes,note,opts,text;nodes=this._currOccurr.find("> .interaction:eq(0)");if(nodes.length===0){nodes=this._currOccurr.parents(".interaction:eq(0):not(.activated)")}text=a;opts=b;note=jumly(".note",text);if(opts){return note.attach(nodes,opts)}else{return nodes.append(note)}};JUMLYSequenceDiagramBuilder.prototype.found=function(something,callback){var actor;actor=this._findOrCreate(something);this._currOccurr=actor.activate();this.last=callback!=null?callback.apply(this,[this]):void 0;return this};JUMLYSequenceDiagramBuilder.prototype.compose=function(opts){if(typeof opts==="function"){opts(this.diagram)}else{if(opts!=null){opts.append(this.diagram)}}return this.diagram.compose(opts)};JUMLYSequenceDiagramBuilder.prototype.preferences=function(){return this.diagram.preferences.apply(this.diagram,arguments)};JUMLYSequenceDiagram.prototype.found=function(something,callback){var b;b=new JUMLYSequenceDiagramBuilder;b.diagram=this;return b.found(something,callback)};JUMLYSequenceDiagramBuilder.prototype.beforeCompose=function(f){this.diagram.bind("beforeCompose",f);return this};JUMLYSequenceDiagramBuilder.prototype.afterCompose=function(f){this.diagram.bind("afterCompose",f);return this};jumly.DSL({type:".sequence-diagram",compileScript:function(script){var b;b=new JUMLYSequenceDiagramBuilder;return b.build(script.html())}});JUMLY.SequenceDiagramBuilder=JUMLYSequenceDiagramBuilder}).call(this);(function(){var UMLComponent,UMLComponentDSL,UMLComponentDiagram,UMLName,UMLPort,UMLProvidedInterface,UMLRequiredInterface,a,mixin;UMLComponent=(function(){function UMLComponent(props,opts){jQuery.extend(this,UMLComponent.newNode());this}UMLComponent.newNode=function(){return $("<div>").addClass("component").append($("<div>").addClass("frame").append($("<div>").addClass("icon")).append($("<div>").addClass("stereotype").text("<<component>>")).append($("<div>").addClass("name")))};return UMLComponent})();$.uml.def(".component",UMLComponent);UMLPort=(function(){function UMLPort(props,opts){jQuery.extend(this,UMLPort.newNode());this}UMLPort.newNode=function(){return $("<div>").addClass("port").append($("<div>").addClass("name")).append($("<div>").addClass("icon"))};return UMLPort})();$.uml.def(".port",UMLPort);UMLProvidedInterface=(function(){function UMLProvidedInterface(props,opts){jQuery.extend(this,UMLProvidedInterface.newNode());this}UMLProvidedInterface.newNode=function(){return $("<div>").addClass("provided-interface").append($("<div>").addClass("name")).append($("<div>").addClass("icon"))};return UMLProvidedInterface})();$.uml.def(".provided-interface",UMLProvidedInterface);UMLRequiredInterface=(function(){function UMLRequiredInterface(props,opts){jQuery.extend(this,UMLRequiredInterface.newNode());this}UMLRequiredInterface.newNode=function(){return $("<div>").addClass("required-interface").append($("<div>").addClass("name")).append($("<div>").addClass("icon"))};return UMLRequiredInterface})();$.uml.def(".required-interface",UMLRequiredInterface);UMLComponentDiagram=(function(){function UMLComponentDiagram(props,opts){jQuery.extend(this,UMLComponentDiagram.newNode());this}UMLComponentDiagram.newNode=function(){return $("<div>").addClass("diagram").addClass("component-diagram")};return UMLComponentDiagram})();UMLComponentDiagram.prototype.compose=function(){this.trigger("beforeCompose",[this]);this.compose_.apply(arguments);this.trigger("afterCompose",[this]);return this};UMLComponentDiagram.prototype.compose_=function(){this.find(".component").each(function(i,e){var compo;compo=$(e).self();return compo.find(".provided-interface, .required-interface").each(function(i,e){var frame,to_left,to_right;frame=compo.find(".frame");to_left=function(e){var t;if(i===0){t=frame.offset().top}else{t=e.prev(1).outerBottom()}e.offset({top:t});return e.addClass("to-left")};to_right=function(e){var t,x;x=frame.offset().left+frame.outerWidth();e.offset({left:x});e.find(".icon").css("-webkit-transform","scale(-1, 1)");t=e.prev().offset().top;e.offset({top:t});return e.addClass("to-right")};if(i%2===0){return to_left($(e))}else{return to_right($(e))}})});return this.find(".relationship").each(function(i,e){return $(e).self().render()})};$.uml.def(".component-diagram",UMLComponentDiagram);UMLComponentDSL=(function(){function UMLComponentDSL(_diagram,_component){this._diagram=_diagram;this._component=_component}return UMLComponentDSL})();UMLComponentDSL.prototype.component=function(name,acts){var compo,ctxt;this._diagram.append(compo=$.uml(".component",name));ctxt=new UMLComponentDSL(this._diagram,compo);if(acts!=null){acts.apply(ctxt,[])}return this};UMLName=(function(){function UMLName(uname){var i;if(typeof uname==="string"){this.name=uname}else{for(i in uname){this.name=i;if(typeof uname[i]==="object"){if($.isArray(uname[i])){throw""+i+" MUST NOT be array"}else{$.extend(this,uname[i])}}}}}UMLName._to=function(uname){return new UMLName(uname)};return UMLName})();UMLComponentDSL.prototype.provide=function(name){var i;i=$.uml(".provided-interface",name);this._component.append(i);return this};UMLComponentDSL.prototype.require=function(name){var i;i=$.uml(".required-interface",name);this._component.append(i);return this};UMLComponentDSL.prototype.compose=function(something){if(typeof something==="function"){something(this._diagram)}else{if(typeof something==="object"&&something.each){something.append(this._diagram)}else{throw something+" MUST be a function or a jQuery object"}}this._diagram.compose();return this};mixin={component:function(name,acts){var ctxt,diag;diag=this;ctxt=new UMLComponentDSL(diag);ctxt.component(name,acts);return ctxt}};a=$.uml(".component-diagram");$.extend(a.constructor.prototype,mixin);$.uml.diagram=function(klass,name,others){var acts,ctxt,diag;acts=([].slice.apply(arguments)).pop();if(!$.isFunction(acts)){throw"Last argument is expected a function"}diag=$.uml("."+klass+"-diagram");ctxt=new UMLComponentDSL(diag);acts.apply(ctxt,[]);return ctxt}}).call(this);(function(){var DeploymentContext,UMLArtifact,UMLDeploymentDiagram,a,mixin;UMLArtifact=(function(){function UMLArtifact(props,opts){jQuery.extend(this,UMLArtifact.newNode());this._movingTo=[];this}UMLArtifact.newNode=function(){return $("<div>").addClass("artifact").append($("<div class='frame'/>").append($("<div class='stereotype'/>").text("<<artifact>>")).append("<div class='name'/>").append("<div class='edge-top'/>").append("<div class='edge-right'/>"))};return UMLArtifact})();UMLArtifact.prototype.preferredWidth=function(w){};UMLArtifact.prototype.moveTo=function(x,y){var self;self=this;return this._movingTo.push(function(){return self._moveTo(x,y)})};UMLArtifact.prototype._moveTo=function(x,y){var index,margintotal,my,p,q;q={};if(typeof x==="object"){q=x}else{if(typeof x==="number"&&typeof y==="number"){q={left:x,top:y}}}p=this.parents(".diagram:eq(0)").offset();if(q.left!=null){this.css({"margin-left":q.left+"px"})}index=this.index();margintotal=0;this.parents(".diagram:eq(0)").find(".artifact").each(function(i,e){var mt,_ref;if(i>=index){return}mt=(_ref=$(e).css("margin-top"))!=null?_ref.toInt():void 0;if(mt==null){mt=0}return margintotal+=mt+$(e).outerHeight()});my=0;if(q.top!=null){my=q.top-margintotal}else{my=-margintotal}return this.css({"margin-top":my+"px"})};UMLArtifact.prototype.render=function(){var bw,f,h,r,t;$(this._movingTo).each(function(i,e){return e()});f=this.find("> .frame");t=f.find("> .edge-top");r=f.find("> .edge-right");bw=f.css("border-right-width").toInt();r.css({position:"absolute"}).height(f.height());h=Math.round(r.outerWidth()/Math.sqrt(3));t.offset({left:f.offset().left+bw/2,top:f.offset().top-t.outerHeight()});return r.offset({left:f.outerRight(),top:f.offset().top-h/2})};$.uml.def(".artifact",UMLArtifact);UMLDeploymentDiagram=(function(){function UMLDeploymentDiagram(props,opts){jQuery.extend(this,UMLDeploymentDiagram.newNode());this}UMLDeploymentDiagram.newNode=function(){return $("<div>").addClass("diagram").addClass("deployment-diagram")};return UMLDeploymentDiagram})();UMLDeploymentDiagram.prototype.compose=function(){this.trigger("beforeCompose",[this]);$(".artifact").each(function(i,e){return $(e).self().render()});this.trigger("afterCompose",[this]);return this};$.uml.def(".deployment-diagram",UMLDeploymentDiagram);DeploymentContext=(function(){function DeploymentContext(_diagram,_deployment){this._diagram=_diagram;this._deployment=_deployment}return DeploymentContext})();DeploymentContext.prototype.deployment=function(name,acts){var compo,ctxt;this._diagram.append(compo=$.uml(".deployment",name));ctxt=new DeploymentContext(this._diagram,compo);if(acts!=null){acts.apply(ctxt,[])}return this};mixin={deployment:function(name,acts){var ctxt,diag;diag=this;ctxt=new DeploymentContext(diag);ctxt.deployment(name,acts);return ctxt}};a=$.uml(".deployment-diagram");$.extend(a.constructor.prototype,mixin)}).call(this);(function(){var replaceSmoothly;var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}};replaceSmoothly=function(that,old,a){a.css({visibility:"hidden"});that.append(a);a.css({left:"",top:"",position:""});a.compose();a.hide();old.css({height:0,padding:0});a.css({visibility:"visible"});a.fadeIn("slow");return old.fadeOut("slow",function(){return t.remove()})};jQuery.fn.jumlize=function(kind,script){var builder,diag,f,g;builder={sequence:JUMLY.SequenceDiagramBuilder};diag=(new builder[kind]).build(script);f=__bind(function(diag){var old;old=this.find("> *");return replaceSmoothly(this,old,diag)},this);g=__bind(function(diag){this.find("> *").remove().end().append(diag);return diag.compose()},this);return g(diag)}}).call(this);(function(){var jumlyBind,name2builder;jumlyBind={init:function(elem,val,bindings,model){},update:function(elem,val,bindings,model){var diag,koarg,_base,_base2;koarg={element:elem,valueAccessor:val,allBindingsAccessor:bindings,viewModel:model};diag=ko.utils.unwrapObservable(val());try{$(elem).html(diag);if(diag.compose==null){throw diag}diag.compose();return typeof(_base2=bindings()).success==="function"?_base2.success({diagram:diag,ko:koarg}):void 0}catch(ex){return typeof(_base=bindings()).error==="function"?_base.error($.extend(ex,{type:ex.constructor.name,diagram:diag,ko:koarg})):void 0}}};name2builder={sequence:JUMLY.SequenceDiagramBuilder};JUMLY.ko={dependentObservable:function(observableJumlipt,builder){if(!ko.isObservable(observableJumlipt)){throw new JUMLY.Error("not_observable","is not observable",[observableJumlipt])}if(typeof builder==="string"){builder=name2builder[builder.toLowerCase()]}return ko.dependentObservable(function(){try{return(new builder).build(observableJumlipt())}catch(ex){return ex}})}};$(function(){if(window.ko){return ko.bindingHandlers.jumly=jumlyBind}})}).call(this);(function(){var LocalStorage;LocalStorage=(function(){function LocalStorage(props,prefix){var key,_i,_len;this.prefix=prefix!=null?prefix:"JUMLY.";for(_i=0,_len=props.length;_i<_len;_i++){key=props[_i];this[key]=LocalStorage._spawn_(key)}}LocalStorage._spawn_=function(name,_kind){if(_kind==null){_kind="string"}return function(val,kind){var key,s;if(kind==null){kind=_kind}key=""+this.prefix+name;s=window.localStorage;if(!val){return s.getItem(key)}else{return s.setItem(key,val)}}};return LocalStorage})();JUMLY.LocalStorage=LocalStorage}).call(this);