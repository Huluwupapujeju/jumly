/* jumly-0.1.3a 2013-03-27 */
(function(){var JUMLY,SCRIPT_TYPE_PATTERN,core,exported,_compilers,_evalHTMLScriptElement,_layouts,_new_builder,_new_layout,_runScripts,_to_type_string,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};if(core={},core._to_id=function(that){return that.constructor===jQuery?that.attr("id"):that.toLowerCase().replace(/[^a-zA-Z0-9_]/g,"-")},core._to_ref=function(s){return s.match(/^[0-9].*/)?"_"+s:s.replace(/^[0-9]|-/g,"_")},core.kindof=function(that){var ctor,toName;return null===that?"Null":void 0===that?"Undefined":(ctor=that.constructor,toName=function(f){return __indexOf.call(f,"name")>=0?f.name:(""+f).replace(/^function\s+([^\(]*)[\S\s]+$/im,"$1")},"function"==typeof ctor?toName(ctor):tc)},core._normalize=function(that){var a,id,it,keys,mods,name,p;switch(core.kindof(that)){case"String":return{id:core._to_id(that),name:that};case"Object":break;default:if(that&&that.constructor===jQuery)return id=core._to_id(that),name=that.find(".name"),null!=id||name.length>0?{id:id,name:name.html()?name.html():void 0}:void 0;throw console.error("Cannot recognize kind:",that),Error("Cannot recognize kind: '"+core.kindof(that)+"'")}if(keys=function(){var _results;_results=[];for(p in that)_results.push(p);return _results}(),keys.length>1)return that;if(id=keys[0],it=that[keys[0]],"String"===core.kindof(it))return{id:id,name:it};if(keys=function(){var _results;_results=[];for(p in it)_results.push(p);return _results}(),keys.length>1)return $.extend({},it,{id:core._to_id(id),name:id});switch(name=keys[0],mods=it[keys[0]],core.kindof(mods)){case"Object":return $.extend({id:id,name:name},mods);case"Array":case"Function":return a={id:core._to_id(id),name:id},a[name]=mods,a}},core.env={is_node:"undefined"!=typeof module&&module.exports!==void 0},JUMLY={env:core.env},core.env.is_node?(global.JUMLY=JUMLY,module.exports=core):(window.JUMLY=JUMLY,exported={core:core,"node-jquery":{},"./jasmine-matchers":{}},JUMLY.require=function(name){if(void 0===name||null===name)throw Error(""+name+" was not properly given");return exported[name]||console.warn("not found:",name),exported[name]},core.exports=function(func,name){return exported[func.name||name]=func}),SCRIPT_TYPE_PATTERN=/text\/jumly-(.*)-diagram|text\/jumly\+(.*)|application\/jumly\+(.*)/,_to_type_string=function(type){var kind;if(!type.match(SCRIPT_TYPE_PATTERN))throw"Illegal type: "+type;return kind=RegExp.$1+RegExp.$2+RegExp.$3},_evalHTMLScriptElement=function(script){var compiler,diag,kind,layout,type;if(script=$(script),type=script.attr("type"),!type)throw"Not found: type attribute in script";if(kind=_to_type_string(type),compiler=_compilers["."+kind+"-diagram"],layout=_layouts["."+kind+"-diagram"],!compiler)throw"Not found: compiler for '."+kind+"'";if(!layout)throw"Not found: layout for '."+kind+"'";return diag=compiler(script),diag.insertAfter(script),layout(diag)},_new_builder=function(type){return function(script){return(new(require(type))).build(script.html())}},_new_layout=function(type){return function(diagram){return(new(require(type))).layout(diagram)}},_compilers={".sequence-diagram":_new_builder("SequenceDiagramBuilder"),".robustness-diagram":_new_builder("RobustnessDiagramBuilder")},_layouts={".sequence-diagram":_new_layout("SequenceDiagramLayout"),".robustness-diagram":_new_layout("RobustnessDiagramLayout")},_runScripts=function(){var diagrams,s,script,scripts,_i,_len;if(_runScripts.done)return null;for(scripts=document.getElementsByTagName("script"),diagrams=function(){var _i,_len,_results;for(_results=[],_i=0,_len=scripts.length;_len>_i;_i++)s=scripts[_i],s.type.match(/text\/jumly+(.*)/)&&_results.push(s);return _results}(),_i=0,_len=diagrams.length;_len>_i;_i++)script=diagrams[_i],_evalHTMLScriptElement(script);return _runScripts.done=!0,null},!core.env.is_node){if(!window.addEventListener)throw"window.addEventListener is not supported";window.addEventListener("DOMContentLoaded",_runScripts)}}).call(this),function(){var Shape,shape_arrow,to_polar_from_cartesian,_line_to,_render_both,_render_dashed,_render_dashed2,_render_line,_render_line2,_render_normal;Shape=function(){function Shape(ctxt){this.ctxt=ctxt,this.pos={left:0,top:0},this.memento=[]}return Shape}(),Shape.prototype.backtrack=function(depth){var i,m;for(this.ctxt.save(),this.ctxt.scale(1,-1),i=0;(m=this.memento.pop())&&(m(),i+=1,!(i>=depth)););return this.ctxt.restore(),this},Shape.prototype.line=function(dx,dy){var _pos,_this=this;return this.pos.left+=dx,this.pos.top+=dy,this.ctxt.lineTo(this.pos.left,this.pos.top),_pos={left:this.pos.left,top:this.pos.top},this.memento.push(function(){return _this.ctxt.lineTo(_pos.left-dx,_pos.top-dy)}),this},Shape.prototype.move=function(dx,dy){var _pos,_this=this;return this.pos.left+=dx,this.pos.top+=dy,this.ctxt.moveTo(this.pos.left,this.pos.top),_pos={left:this.pos.left,top:this.pos.top},this.memento.push(function(){return _this.ctxt.moveTo(_pos.left-dx,_pos.top-dy)}),this},Shape.prototype.lineTo=function(p,q){var _pos,_this=this;return _pos={left:this.pos.left,top:this.pos.top},this.ctxt.lineTo(p,q),this.pos.left=p,this.pos.top=q,this.memento.push(function(){return _this.ctxt.lineTo(_pos.left,_pos.top)}),this},Shape.prototype.moveTo=function(p,q){var _pos,_this=this;return _pos={left:this.pos.left,top:this.pos.top},this.ctxt.moveTo(p,q),this.pos.left=p,this.pos.top=q,this.memento.push(function(){return _this.ctxt.moveTo(_pos.left,_pos.top)}),this},to_polar_from_cartesian=function(src,dst){var dx,dy;return dx=dst.left-src.left,dy=dst.top-src.top,{offset:{left:src.left,top:src.top},radius:Math.sqrt(dx*dx+dy*dy),declination:Math.atan(dy/dx),quadrants:{x:0!==dx?dx/Math.abs(dx):1,y:0!==dy?dy/Math.abs(dy):1}}},_line_to=function(ctxt,src,dst,styles){var i,p,pattern,plen,x,_i,_ref;if(!styles)return ctxt.moveTo(src.left,src.top),ctxt.lineTo(dst.left,dst.top),void 0;if(styles=$.extend({pattern:[4,4]},styles),p=to_polar_from_cartesian(src,dst),ctxt.save(),ctxt.translate(p.offset.left,p.offset.top),ctxt.rotate(p.declination),ctxt.scale(p.quadrants.x,p.quadrants.y),ctxt.moveTo(0,0),pattern=styles.pattern,plen=pattern[0]+pattern[1],p.radius>0)for(i=_i=0,_ref=p.radius-1;plen>0?_ref>=_i:_i>=_ref;i=_i+=plen)x=i+pattern[0],x>=p.radius-1&&(x=p.radius-1),ctxt.lineTo(x,0),ctxt.moveTo(i+plen,0);return ctxt.restore()},_render_both=function(ctxt,a,r,e,dt){return a.line(e.height,e.width+dt).line(0,-dt).line(r-2*e.height,0).line(0,dt).line(e.height,-(e.width+dt)).backtrack(),ctxt.closePath()},_render_line=function(ctxt,a,r,e){return a.moveTo(0,0).line(r,0).line(-e.height,e.base).move(e.height,-e.base).line(-e.height,-e.base),delete e.fillStyle},_render_line2=function(ctxt,a,r,e){return a.moveTo(0,0).line(r-e.height,0).line(0,e.base).line(e.height,-e.base).backtrack()},_render_dashed=function(ctxt,a,r,e){return _line_to(ctxt,{left:0,top:0},{left:r,top:0},{pattern:e.pattern}),_line_to(ctxt,{left:r,top:0},{left:r-e.height,top:e.base}),_line_to(ctxt,{left:r,top:0},{left:r-e.height,top:-e.base}),delete e.fillStyle},_render_dashed2=function(ctxt,a,r,e){return _line_to(ctxt,{left:0,top:0},{left:r-e.height,top:0},{pattern:e.pattern}),a.moveTo(r-e.height,0).line(0,e.base).line(e.height,-e.base).line(-e.height,-e.base).line(0,e.base)},_render_normal=function(ctxt,a,r,e,dt){return a.moveTo(0,0).line(0,e.width).line(r-e.height,0).line(0,dt).line(e.height,-(e.width+dt)).backtrack(),ctxt.closePath()},shape_arrow=function(ctxt,src,dst,styles){var a,dt,e,p,r,_ref;switch(p=to_polar_from_cartesian({left:src.x,top:src.y},{left:dst.x,top:dst.y}),r=p.radius,ctxt.save(),ctxt.translate(src.x,src.y),ctxt.rotate(p.declination),ctxt.scale(p.quadrants.x,p.quadrants.y),e=$.extend({width:20,base:35,height:50,pattern:[4,4],shape:null},styles),null==(_ref=e.lineWidth)&&(e.lineWidth=1),$.extend(ctxt,e),ctxt.beginPath(),e.tosrc&&(ctxt.translate(r,0),ctxt.rotate(Math.PI)),a=new Shape(ctxt),dt=e.base-e.width,styles.shape){case"both":_render_both(ctxt,a,r,e,dt);break;case"line":_render_line(ctxt,a,r,e,dt);break;case"dashed":_render_dashed(ctxt,a,r,e,dt);break;case"dashed2":_render_dashed2(ctxt,a,r,e,dt);break;case"line2":_render_line2(ctxt,a,r,e,dt);break;default:_render_normal(ctxt,a,r,e,dt)}return ctxt.stroke(),e.fillStyle&&ctxt.fill(),ctxt.restore()},$.g2d={arrow:shape_arrow,path:Shape}}.call(this),function(){var _choose,_max,_min;_max=function(nodes,ef){return _choose(nodes,ef,function(a,b){return b-a})},_min=function(nodes,ef){return _choose(nodes,ef,function(a,b){return a-b})},_choose=function(nodes,ef,cmpf){return $.map(nodes,ef).sort(cmpf)[0]},$.fn.choose=function(ef,cmpf){return _choose(this,ef,cmpf)},$.fn.max=function(ef){return _max(this,ef)},$.fn.min=function(ef){return _min(this,ef)},$.fn.outerBottom=function(){return this.offset().top+this.outerHeight()-1},$.fn.mostLeftRight=function(margin){return{left:this.min(function(e){return $(e).offset().left-(margin?parseInt($(e).css("margin-left")):0)}),right:this.max(function(e){var t;return t=$(e).offset().left+$(e).outerWidth()+(margin?parseInt($(e).css("margin-right")):0),0>t-1?0:t-1}),width:function(){return null!=this.right&&null!=this.left?this.right-this.left+1:0}}},$.fn.mostTopBottom=function(margin){return{top:this.min(function(e){return $(e).offset().top-(margin?parseInt($(e).css("margin-top")):0)}),bottom:this.max(function(e){var t;return t=$(e).offset().top+$(e).outerHeight()+(margin?parseInt($(e).css("margin-bottom")):0),0>t-1?0:t-1}),height:function(){return null!=this.top&&null!=this.bottom?this.bottom-this.top+1:0}}},$.fold=function(list,init,func){var e,l,_i,_len;for(l=init,_i=0,_len=list.length;_len>_i;_i++)e=list[_i],l=func.apply(null,[l,e]);return l},$.reduce=function(list,func){return 0===list.length?void 0:$.fold(list.slice(1),list[0],func)}}.call(this),function(){var HTMLElement,core,self;self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=function(){function HTMLElement(args,f){var cls,me,root;cls=HTMLElement.to_css_name(this.constructor.name),me=$.extend(this,root=$("<div>").addClass(cls)),"function"==typeof f&&f(me),args&&me.find(".name").text(args),me.data("_self",me)}return HTMLElement.to_css_name=function(s){return(s.match(/Diagram$/)?s.replace(/Diagram$/,"-Diagram"):s.match(/NoteElement/)?s.replace(/Element$/,""):s.replace(/^[A-Z][a-z]+/,"")).toLowerCase()},HTMLElement}(),HTMLElement.prototype.preferred_width=function(){return this.find("> *:eq(0)").outerWidth()},core=self.require("core"),core.env.is_node?module.exports=HTMLElement:core.exports(HTMLElement)}.call(this),function(){var Diagram,HTMLElement,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),core=self.require("core"),Diagram=function(_super){function Diagram(){Diagram.__super__.constructor.call(this),this.addClass("diagram")}return __extends(Diagram,_super),Diagram}(HTMLElement),Diagram.prototype._var=function(varname,e){return eval(""+varname+" = e")},Diagram.prototype._reg_by_ref=function(id,obj){var exists,ref;if(exists=function(id){return $("#"+id).length>0},ref=core._to_ref(id),this[ref])throw Error("Already exists for '"+ref+"'");if(exists(id,this))throw Error("Element which has same ID("+id+") already exists in the document.");return this[ref]=obj,ref},core.env.is_node?module.exports=Diagram:core.exports(Diagram)}.call(this),function(){var CoffeeScript,DiagramBuilder,core,self;self={require:"undefined"!=typeof require?require:JUMLY.require},DiagramBuilder=function(){function DiagramBuilder(){}return DiagramBuilder}(),core=self.require("core"),CoffeeScript=core.env.is_node?require("coffee-script"):window.CoffeeScript,DiagramBuilder.prototype.build=function(script){return function(){return eval(CoffeeScript.compile(script))}.apply(this,[]),this._diagram},DiagramBuilder.prototype.diagram=function(){return this._diagram},DiagramBuilder.prototype._refer=function(ref,adv){var id,r;return id=core._normalize(adv.by).id,this._diagram._reg_by_ref(id,ref),r=core._to_ref(id),this._diagram._var(r,ref)},core.env.is_node?module.exports=DiagramBuilder:core.exports(DiagramBuilder)}.call(this),function(){var DiagramLayout,core,self;self={require:"undefined"!=typeof require?require:JUMLY.require},DiagramLayout=function(){function DiagramLayout(){}return DiagramLayout}(),DiagramLayout.prototype.layout=function(diagram){return this.diagram=diagram,"function"==typeof this._layout?this._layout():void 0},core=self.require("core"),core.env.is_node?module.exports=DiagramLayout:core.exports(DiagramLayout)}.call(this),function(){var HorizontalSpacing,core,root,self;self={require:"undefined"!=typeof require?require:JUMLY.require},HorizontalSpacing=function(){function HorizontalSpacing(a,b){$.extend(this,$("<span>")),this.data("left",a),this.data("right",b),this.addClass("horizontal"),this.addClass("spacing")}return HorizontalSpacing}(),HorizontalSpacing.prototype.apply=function(){var a,b;return a=this.data("left").data("_self"),b=this.data("right").data("_self"),a.after(this),this.offset({left:a.offset().left+a.preferred_width(),top:a.offset().top}),b.offset({left:this.offset().left+this.outerWidth()})},root={HorizontalSpacing:HorizontalSpacing},core=self.require("core"),core.env.is_node?module.exports=root:core.exports(root,"HTMLElementLayout")}.call(this),function(){var HTMLElement,NoteElement,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),NoteElement=function(_super){function NoteElement(args,attrs){NoteElement.__super__.constructor.call(this,args,function(me){return me.append($("<div>").addClass("name"))}),attrs&&this.css(attrs.css)}return __extends(NoteElement,_super),NoteElement}(HTMLElement),core=self.require("core"),core.env.is_node?module.exports=NoteElement:core.exports(NoteElement)}.call(this),function(){var Position,PositionLeft,PositionLeftRight,PositionRightLeft,PositionTop,core,self,_ref,_ref1,_ref2,_ref3,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},Position=function(){function Position(attrs){this.attrs=attrs,this.div=$("<div>").addClass(this.attrs.css).css({position:"absolute"})}return Position}(),Position.prototype._coordinate=function(target){return this.attrs.coordinate?this.attrs.coordinate.append(this.div):target.after(this.div)},PositionRightLeft=function(_super){function PositionRightLeft(){return _ref=PositionRightLeft.__super__.constructor.apply(this,arguments)}return __extends(PositionRightLeft,_super),PositionRightLeft}(Position),PositionLeftRight=function(_super){function PositionLeftRight(){return _ref1=PositionLeftRight.__super__.constructor.apply(this,arguments)}return __extends(PositionLeftRight,_super),PositionLeftRight}(Position),PositionLeft=function(_super){function PositionLeft(){return _ref2=PositionLeft.__super__.constructor.apply(this,arguments)}return __extends(PositionLeft,_super),PositionLeft}(Position),PositionTop=function(_super){function PositionTop(){return _ref3=PositionTop.__super__.constructor.apply(this,arguments)}return __extends(PositionTop,_super),PositionTop}(Position),PositionRightLeft.prototype.apply=function(){var src;return src=this.attrs.src,this._coordinate(src),this.div.offset({left:src.offset().left+src.outerWidth()}),this.attrs.dst.offset({left:this.div.offset().left+this.div.outerWidth()})},PositionLeftRight.prototype.apply=function(){var dst,src;return src=this.attrs.src,dst=this.attrs.dst,this._coordinate(src),this.div.offset({left:src.offset().left-this.div.outerWidth()}),this.attrs.dst.offset({left:this.div.offset().left-this.attrs.dst.outerWidth()})},PositionLeft.prototype.apply=function(){var dst;return dst=this.attrs.dst,this._coordinate(dst),this.attrs.dst.offset({left:this.div.offset().left+this.div.outerWidth()})},PositionTop.prototype.apply=function(){var dst;return dst=this.attrs.dst,this._coordinate(dst),this.attrs.dst.offset({top:this.div.offset().top+this.div.outerHeight()})},Position.RightLeft=PositionRightLeft,Position.LeftRight=PositionLeftRight,Position.Left=PositionLeft,Position.Top=PositionTop,core=self.require("core"),core.env.is_node?module.exports=Position:core.exports(Position)}.call(this),function(){var HTMLElement,MESSAGE_STYLE,Relationship,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),Relationship=function(_super){function Relationship(args,opts){this.src=opts.src,this.dst=opts.dst,Relationship.__super__.constructor.call(this,args,function(me){return me.addClass("relationship").append($("<canvas>").addClass("icon")).append($("<div>").addClass("name"))})}return __extends(Relationship,_super),Relationship}(HTMLElement),MESSAGE_STYLE={width:1,base:6,height:10,lineWidth:1.5,shape:"dashed",pattern:[8,8],strokeStyle:"gray",fillStyle:"gray",lineJoin:"round"},Math.sign=function(x){return 0===x?0:x>0?1:-1},$.fn.cssAsInt=function(name){var a;return a=this.css(name),a?parseInt(a):0},Relationship.prototype._point=function(obj){var dh,dv,margin_left,margin_top,s;return margin_left=$("body").cssAsInt("margin-left"),margin_top=$("body").cssAsInt("margin-top"),s=obj.offset(),dh=-obj.cssAsInt("margin-left")-margin_left,dv=-obj.cssAsInt("margin-top")-margin_top,{left:s.left+obj.outerWidth()/2+dh,top:s.top+obj.outerHeight()/2+dv}},Relationship.prototype._rect=function(p,q){var a,b,h,hs,l,vs,w;return a={left:Math.min(p.left,q.left),top:Math.min(p.top,q.top)},b={left:Math.max(p.left,q.left),top:Math.max(p.top,q.top)},w=b.left-a.left+1,h=b.top-a.top+1,hs=Math.sign(q.left-p.left),vs=Math.sign(q.top-p.top),l=Math.sqrt(w*w+h*h),{left:a.left,top:a.top,width:w,height:h,hsign:hs,vsign:vs,hunit:hs*w/l,vunit:vs*h/l}},Relationship.prototype.render=function(){var aa,bb,cc,cr,ctxt,dd,p,q,r,s,style,t;return p=this._point(this.src),q=this._point(this.dst),r=this._rect(p,q),cr=2,aa=r.hunit*this.dst.outerWidth()/cr,bb=r.vunit*this.dst.outerHeight()/cr,cc=r.hunit*this.src.outerWidth()/cr,dd=r.vunit*this.src.outerHeight()/cr,s={x:p.left-r.left+cc,y:p.top-r.top+dd},t={x:q.left-r.left-aa,y:q.top-r.top-bb},this.width(r.width),this.height(r.height),this.offset({left:r.left,top:r.top}),ctxt=this.find("canvas").css({width:r.width,height:r.height}).attr({width:r.width,height:r.height})[0].getContext("2d"),ctxt.save(),style=$.extend({},MESSAGE_STYLE,{pattern:[4,4],shape:"line"}),this.hasClass("extend")&&(style=$.extend(style,{shape:"dashed"})),$.g2d.arrow(ctxt,s,t,style),ctxt.restore()},core=self.require("core"),core.env.is_node?module.exports=Relationship:core.exports(Relationship)}.call(this),function(){var HTMLElement,SequenceLifeline,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),SequenceLifeline=function(_super){function SequenceLifeline(_object){this._object=_object,self=this,SequenceLifeline.__super__.constructor.call(this,null,function(me){return me.append($("<div>").addClass("line")).width(self._object.width())})}return __extends(SequenceLifeline,_super),SequenceLifeline}(HTMLElement),core=self.require("core"),core.env.is_node?module.exports=SequenceLifeline:core.exports(SequenceLifeline)}.call(this),function(){var HTMLElement,MESSAGE_STYLE,STEREOTYPE_STYLES,SequenceMessage,core,self,_determine_primary_stereotype,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),SequenceMessage=function(_super){function SequenceMessage(_iact,_actee){this._iact=_iact,this._actee=_actee,SequenceMessage.__super__.constructor.call(this,null,function(me){return me.append($("<canvas>").addClass("arrow")).append($("<div>").addClass("name"))})}return __extends(SequenceMessage,_super),SequenceMessage}(HTMLElement),SequenceMessage.prototype._lineToNextOccurr=function(canvas){var dstll,srcll;return srcll=this._srcOccurr(),dstll=this._dstOccurr(),this._toLine(srcll,dstll,canvas)},SequenceMessage.prototype._toLine=function(src,dst,canvas){var e,y;return e=!this.parent().hasClass("lost")&&this.isTowardLeft()?{src:{x:src.offset().left-this.offset().left},dst:{x:dst.outerWidth()}}:{src:{x:src.outerWidth()},dst:{x:dst.offset().left-src.offset().left}},y=canvas.outerHeight()/2,e.src.y=y,e.dst.y=y,e},SequenceMessage.prototype._srcOccurr=function(){return this.parents(".occurrence:eq(0)").self()},SequenceMessage.prototype._dstOccurr=function(){return(this.hasClass("return")?this.prev(".occurrence"):$("~ .occurrence",this)).self()},SequenceMessage.prototype._prefferedCanvas=function(){return this.find("canvas:eq(0)").attr({width:this.width(),height:this.height()}).css({width:this.width(),height:this.height()})},SequenceMessage.prototype._toCreateLine=function(canvas){var e,outerRight,src;return e=this._toLine(this._srcOccurr(),this._dstOccurr()._actor,canvas),this.isTowardLeft()&&(src=this._srcOccurr(),outerRight=function(it){return it.offset().left+it.outerWidth()},e.dst.x=outerRight(src._actor)-src.offset().left),e},SequenceMessage.prototype._findOccurr=function(actee){var occurr;return occurr=null,this.parents(".occurrence").each(function(i,e){return e=$(e).data("_self"),e._actor===actee?occurr=e:void 0}),occurr},MESSAGE_STYLE={width:1,base:6,height:10,lineWidth:1.5,shape:"line2",pattern:[8,8],strokeStyle:"gray",fillStyle:"gray"},STEREOTYPE_STYLES={create:{shape:"dashed"},asynchronous:{shape:"line"},synchronous:{shape:"line2",fillStyle:"gray"},destroy:{shape:"line2",fillStyle:"gray"}},_determine_primary_stereotype=function(jqnode){var e,_i,_len,_ref;for(_ref=["create","asynchronous","synchronous","destroy"],_i=0,_len=_ref.length;_len>_i;_i++)if(e=_ref[_i],jqnode.hasClass(e))return e},SequenceMessage.prototype.repaint=function(){var a,arrow,canvas,ctxt,gap,line,llw,newdst,newsrc,rcx,rey,shape;return shape=STEREOTYPE_STYLES[_determine_primary_stereotype(this)],arrow=jQuery.extend({},MESSAGE_STYLE,shape),canvas=this._current_canvas=this._prefferedCanvas(),this.hasClass("self")?(ctxt=canvas[0].getContext("2d"),gap=2,rcx=this.width()-(gap+4),rey=this.height()-(arrow.height/2+4),llw=this._dstOccurr().outerWidth(),$.g2d.arrow(ctxt,{x:rcx,y:rey},{x:llw+gap,y:rey},arrow),arrow.base=0,$.g2d.arrow(ctxt,{x:llw/2+gap,y:gap},{x:rcx,y:gap},arrow),$.g2d.arrow(ctxt,{x:rcx,y:gap},{x:rcx,y:rey},arrow),this):(this.hasClass("create")?line=this._toCreateLine(canvas):this._actee?(newsrc=this._findOccurr(this._actee),newdst=this._dstOccurr(),line=this._toLine(newsrc,newdst,canvas)):line=this._lineToNextOccurr(canvas),this.hasClass("reverse")&&(a=line.src,line.src=line.dst,line.dst=a,arrow.shape="dashed"),jQuery.g2d.arrow(canvas[0].getContext("2d"),line.src,line.dst,arrow),this)},SequenceMessage.prototype.isToward=function(dir){var actee,actor;return actor=this._iact._actor._actor,actee=this._iact._actee._actor,"right"===dir?actor.isLeftAt(actee):"left"===dir?actor.isRightAt(actee):void 0},SequenceMessage.prototype.isTowardRight=function(){return this.isToward("right")},SequenceMessage.prototype.isTowardLeft=function(){return this.isToward("left")},SequenceMessage.prototype._to_be_creation=function(){var dst,line_width,shift_downward,src;return src=this._srcOccurr(),dst=this._dstOccurr(),line_width=function(msg){var l;return l=msg._toLine(src,dst._actor,msg),Math.abs(l.src.x-l.dst.x)},shift_downward=function(msg){var mt,obj;return obj=dst._actor,obj.offset({top:msg.offset().top-obj.height()/3}),mt=parseInt(dst.css("margin-top")),dst.offset({top:obj.outerBottom()+mt})},this.outerWidth(line_width(this)+src.outerWidth()-1),shift_downward(this)},core=self.require("core"),core.env.is_node?module.exports=SequenceMessage:core.exports(SequenceMessage)}.call(this),function(){var HTMLElement,SequenceInteraction,SequenceMessage,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),SequenceInteraction=function(_super){function SequenceInteraction(_actor,_actee){this._actor=_actor,this._actee=_actee,self=this,SequenceInteraction.__super__.constructor.call(this,null,function(me){return me.append(new SequenceMessage(self))})}return __extends(SequenceInteraction,_super),SequenceInteraction}(HTMLElement),SequenceInteraction.prototype.interact=function(obj){return this.awayfrom().interact(obj)},SequenceInteraction.prototype.forward=function(){return this.toward()},SequenceInteraction.prototype.to=function(func){var occurrs,tee,tor;return occurrs=this.gives(".occurrence"),tee=occurrs.as(".actee"),tor=occurrs.as(".actor"),func(tee,tor)},SequenceInteraction.prototype.forwardTo=function(){return this.gives(".occurrence").as(".actee")},SequenceInteraction.prototype.backwardTo=function(){return this.gives(".occurrence").as(".actor")},SequenceInteraction.prototype.toward=function(){return this.forwardTo()},SequenceInteraction.prototype.awayfrom=function(obj){var e,_i,_len,_ref;if(!obj)return this.backwardTo();for(_ref=this.parents(".occurrence").not(".activated"),_i=0,_len=_ref.length;_len>_i;_i++)if(e=_ref[_i],e=$(e).self(),(null!=e?e.gives(".participant"):void 0)===obj)return e;return obj.activate()},SequenceInteraction.prototype._compose_=function(){var actee,dst,errmsg,msg,newdst,rmsg,src,that,w,x;if(that=this,src=this._actor,dst=this._actee,msg=that.find("> .message").data("_self"),this.isToSelf())return this._buildSelfInvocation(src,dst,msg),void 0;if(w=src.offset().left-(dst.offset().left+$(".occurrence:eq(0)",that).width()),this.hasClass("lost")?msg.height(dst.outerHeight()):msg.isTowardLeft()&&(w=dst.offset().left-(src.offset().left+$(".occurrence:eq(0)",that).width())),msg.width(Math.abs(w)).offset({left:Math.min(src.offset().left,dst.offset().left)}).repaint(),rmsg=$("> .message.return:last",that).data("_self")){if(x=msg.offset().left,actee=rmsg._actee){if(newdst=rmsg._findOccurr(actee),!newdst)throw errmsg="SemanticError: it wasn't able to reply back to '"+actee.find(".name").text()+"' which is missing",Error(errmsg);w=dst.offset().left-newdst.offset().left,x=Math.min(dst.offset().left,newdst.offset().left)}return rmsg.width(Math.abs(w)).offset({left:x}).addClass("reverse").repaint()}},SequenceInteraction.prototype._buildSelfInvocation=function(a,b,msg){var arrow,dx,dy,w;return w=this.find(".occurrence:eq(0)").outerWidth(),dx=2*w,dy=1*w,b.css({top:0+dy}),this.css({"padding-bottom":dy}),msg.css({top:0}).width(b.width()+dx).height(b.offset().top-msg.offset().top+dy+w/8).offset({left:b.offset().left}),msg.addClass("self"),msg.repaint(),arrow=msg.find(".arrow"),msg.find(".name").offset({left:arrow.offset().left+arrow.outerWidth(),top:arrow.offset().top})},SequenceMessage=self.require("SequenceMessage"),SequenceInteraction.prototype.reply=function(p){var a,name;return this.addClass("reply"),a=new SequenceMessage(this,null!=p?p[".actee"]:void 0).addClass("return").insertAfter(this.children(".occurrence:eq(0)")),name=function(it){return(null!=it?it.name:void 0)?it.name:$(p).find(".name:eq(0)").text()},$(a).find(".name:eq(0)").text(name(p)),this},SequenceInteraction.prototype.fragment=function(){var SequenceFragment,frag;return SequenceFragment=self.require("SequenceFragment"),frag=new SequenceFragment,frag.enclose(this)},SequenceInteraction.prototype.isToSelf=function(){var a,b;return a=this._actor,b=this._actee,a&&b?a._actor===b._actor:!1},SequenceInteraction.prototype.is_to_itself=function(){return this.isToSelf()},core=self.require("core"),core.env.is_node?module.exports=SequenceInteraction:core.exports(SequenceInteraction)}.call(this),function(){var HTMLElement,SequenceInteraction,SequenceOccurrence,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),SequenceOccurrence=function(_super){function SequenceOccurrence(_actor){this._actor=_actor,SequenceOccurrence.__super__.constructor.call(this)}return __extends(SequenceOccurrence,_super),SequenceOccurrence}(HTMLElement),core=self.require("core"),SequenceInteraction=self.require("SequenceInteraction"),SequenceOccurrence.prototype.interact=function(actor,acts){var SequenceFragment,alt,iact,occurr;if(".lost"===(null!=acts?acts.stereotype:void 0))occurr=(new SequenceOccurrence).addClass("icon"),iact=new SequenceInteraction(this,occurr),iact.addClass("lost");else if(".destroy"===(null!=acts?acts.stereotype:void 0));else{if(".alt"===(null!=actor?actor.stereotype:void 0))return SequenceFragment=self.require("SequenceFragment"),alt=new SequenceFragment("alt"),alt.alter(this,acts),this;occurr=new SequenceOccurrence(actor),iact=new SequenceInteraction(this,occurr)}return actor===iact._actor._actor&&iact.addClass("self"),iact.append(occurr).appendTo(this),iact},SequenceOccurrence.prototype.create=function(objsrc){var SequenceParticipant,iact,obj;return SequenceParticipant=self.require("SequenceParticipant"),obj=new SequenceParticipant(objsrc.name).addClass("created-by"),this._actor.parent().append(obj),iact=this.interact(obj).addClass("creating").find(".message").addClass("create").end()},SequenceOccurrence.prototype._move_horizontally=function(){var left;return this.parent().hasClass("lost")?(offset({left:this.parents(".diagram").find(".participant").mostLeftRight().right}),this):(left=this.is_on_another()?this._parent_occurr().offset().left:this._actor.offset().left+(this._actor.preferred_width()-this.width())/2,left+=this.width()*this._shift_to_parent()/2,this.offset({left:left}))},SequenceOccurrence.prototype.is_on_another=function(){return!(null===this._parent_occurr())},SequenceOccurrence.prototype._parent_occurr=function(){var i,occurrs,_i,_ref;if(occurrs=this.parents(".occurrence"),0===occurrs.length)return null;for(i=_i=0,_ref=occurrs.length-1;_ref>=0?_ref>=_i:_i>=_ref;i=_ref>=0?++_i:--_i)if(this._actor===$(occurrs[i]).data("_self")._actor)return $(occurrs[i]).data("_self");return null},SequenceOccurrence.prototype._shift_to_parent=function(){var a;return this.is_on_another()?(a=this.parent().find(".message:eq(0)").data("_self"),void 0===a?0:a.isTowardRight()?-1:a.isTowardLeft()?1:1):0
},SequenceOccurrence.prototype.preceding=function(obj){var f;return f=function(ll){var a;return a=jumly(ll.parents(".occurrence:eq(0)"))[0],a?a.gives(".participant")===obj?a:f(a):null},f(this)},SequenceOccurrence.prototype.destroy=function(actee){var occur;return occur=this.interact(actee).data("_self")._actee,occur.is_on_another()&&(occur=occur._parent_occurr()),$("<div>").addClass("stop").append($("<div>").addClass("icon").addClass("square").addClass("cross")).insertAfter(occur),occur},core.env.is_node?module.exports=SequenceOccurrence:core.exports(SequenceOccurrence)}.call(this),function(){var HTMLElement,SequenceInteraction,SequenceOccurrence,SequenceParticipant,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),SequenceParticipant=function(_super){function SequenceParticipant(args){SequenceParticipant.__super__.constructor.call(this,args,function(me){return me.append($("<div>").addClass("name"))})}return __extends(SequenceParticipant,_super),SequenceParticipant}(HTMLElement),core=self.require("core"),SequenceOccurrence=self.require("SequenceOccurrence"),SequenceInteraction=self.require("SequenceInteraction"),SequenceParticipant.prototype.activate=function(){var iact,occurr;return occurr=new SequenceOccurrence(this),iact=new SequenceInteraction(null,occurr),iact.addClass("activated"),iact.find(".message").remove(),iact.append(occurr),this.parent().append(iact),occurr},SequenceParticipant.prototype.isLeftAt=function(a){return this.offset().left<a.offset().left},SequenceParticipant.prototype.isRightAt=function(a){return a.offset().left+a.width()<this.offset().left},SequenceParticipant.prototype.iconify=function(fixture,styles){var canvas,container,render,size,_ref,_this=this;return"function"!=typeof fixture&&(fixture=$.jumly.icon["."+fixture]||$.jumly.icon[".actor"]),canvas=$("<canvas>").addClass("icon"),container=$("<div>").addClass("icon-container"),this.addClass("iconified").prepend(container.append(canvas)),_ref=fixture(canvas[0],styles),size=_ref.size,styles=_ref.styles,container.css({height:size.height}),render=function(){var name;return name=_this.find(".name"),styles.fillStyle=name.css("background-color"),styles.strokeStyle=name.css("border-top-color"),fixture(canvas[0],styles)},this.renderIcon=function(){return render()},this},SequenceParticipant.prototype.lost=function(){return this.activate().interact(null,{stereotype:".lost"})},core.env.is_node?module.exports=SequenceParticipant:core.exports(SequenceParticipant)}.call(this),function(){var HTMLElement,SequenceFragment,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),SequenceFragment=function(_super){function SequenceFragment(args){SequenceFragment.__super__.constructor.call(this,args,function(me){return me.append($("<div>").addClass("header").append($("<div>").addClass("name")).append($("<div>").addClass("condition")))})}return __extends(SequenceFragment,_super),SequenceFragment}(HTMLElement),SequenceFragment.prototype.enclose=function(_){var a,b,i,_i,_ref;if(null==_||0===_.length)throw"SequenceFragment::enclose arguments are empty.";if(_.length>1)for(a=$(_[0]).parent()[0],i=_i=1,_ref=_.length-1;_ref>=1?_ref>=_i:_i>=_ref;i=_ref>=1?++_i:--_i)if(b=$(_[i]).parent()[0],a!==b)throw{message:"different parent",nodes:[a,b]};return void 0===_.parent?this:(this.swallow(_),this)},SequenceFragment.prototype.alter=function(occurr,acts){var alt,name,nodes;alt=this,alt.addClass("alt").find(".condition").remove(),occurr.append(alt);for(name in acts)nodes=acts[name](),0!==nodes.length&&(alt.append($("<div>").addClass("condition").html(name)),alt.append(nodes),alt.append($("<div>").addClass("divider")));return alt.find(".divider:last").remove(),alt},core=self.require("core"),core.env.is_node?module.exports=SequenceFragment:core.exports(SequenceFragment)}.call(this),function(){var HTMLElement,SequenceRef,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),SequenceRef=function(_super){function SequenceRef(args){SequenceRef.__super__.constructor.call(this,args,function(div){return div.append($("<div>").addClass("header").append($("<div>").addClass("tag").html("ref"))).append($("<div>").addClass("name"))})}return __extends(SequenceRef,_super),SequenceRef}(HTMLElement),SequenceRef.prototype.preferred_left_and_width=function(){var alt,d,dh,diag,dl,iact,it,l,left,lines,most,objs,occurr,occurs,r,right,w;return occurr=this.parents(".occurrence:eq(0)"),1===occurr.length?(w=occurr.outerWidth(),right=occurr.offset().left+w,{left:right-w/2}):(diag=this.parents(".sequence-diagram:eq(0)"),iact=this.prevAll(".interaction:eq(0)"),0===iact.length?(lines=$(".lifeline .line",diag),most=lines.mostLeftRight(),most.width=most.width(),most):(objs=diag.find(".participant"),0===objs.length?{}:1===objs.length?(it=objs.filter(":eq(0)"),w=parseInt(this.css("min-width")||this.css("max-width")||this.css("width")),l=it.offset().left-(w-it.outerWidth())/2,0>(dl=l-it.offset().left)&&(this.css({"margin-left":dl}),diag.css({"margin-left":-dl})),{left:"auto"}):1===(alt=this.parents(".alt:eq(0)")).length?(left=alt.parents(".occurrence"),l=left.offset().left+left.outerWidth()-1,r=this.parent().find(".occurrence").max(function(e){return $(e).offset().left+$(e).outerWidth()/2}),d=left.outerWidth()/2-1,{left:l-d,width:r-l}):(dh=diag.self().find(".occurrence:eq(0)").width(),occurs=iact.find(".occurrence"),most=occurs.mostLeftRight(),most.left-=dh,most.width=most.width(),most)))},core=self.require("core"),core.env.is_node?module.exports=SequenceRef:core.exports(SequenceRef),console.log("Ref loaded")}.call(this),function(){var Diagram,HTMLElement,SequenceDiagram,core,jumly,prefs_,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},HTMLElement=self.require("HTMLElement"),jumly=$.jumly,jQuery.fn.swallow=function(_,f){return f=f||jQuery.fn.append,1===_.length?0===_.index()?_.parent().prepend(this):this.insertAfter(_.prev()):0===_.index()?this.prependTo($(_[0]).parent()):this.insertBefore(_[0]),this.append(_.detach()),this},Diagram=self.require("Diagram"),SequenceDiagram=function(_super){function SequenceDiagram(){SequenceDiagram.__super__.constructor.call(this)}return __extends(SequenceDiagram,_super),SequenceDiagram}(Diagram),SequenceDiagram.prototype.gives=function(query){var e,f;return e=this.find(query),f=jumly.lang._of(e,query),{of:f}},prefs_={WIDTH:null,HEIGHT:50},SequenceDiagram.prototype.$=function(sel){return jumly($(sel,this))},SequenceDiagram.prototype.$0=function(typesel){return this.$(typesel)[0]},core=self.require("core"),core.env.is_node?module.exports=SequenceDiagram:core.exports(SequenceDiagram)}.call(this),function(){var DiagramBuilder,NoteElement,SequenceDiagram,SequenceDiagramBuilder,SequenceFragment,SequenceParticipant,SequenceRef,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},core=self.require("core"),DiagramBuilder=self.require("DiagramBuilder"),SequenceDiagram=self.require("SequenceDiagram"),SequenceParticipant=self.require("SequenceParticipant"),SequenceRef=self.require("SequenceRef"),SequenceFragment=self.require("SequenceFragment"),SequenceDiagramBuilder=function(_super){function SequenceDiagramBuilder(_diagram,_occurr){var _ref;this._diagram=_diagram,this._occurr=_occurr,SequenceDiagramBuilder.__super__.constructor.call(this),null==(_ref=this._diagram)&&(this._diagram=new SequenceDiagram)}return __extends(SequenceDiagramBuilder,_super),SequenceDiagramBuilder}(DiagramBuilder),SequenceDiagramBuilder.prototype._curr_occurr=function(){return this._occurr},SequenceDiagramBuilder.prototype._curr_actor=function(){return this._occurr._actor},SequenceDiagramBuilder.prototype.found=function(sth,callback){var actor;return actor=this._find_or_create(sth),actor.addClass("found"),this._occurr=actor.activate(),null!=callback&&callback.apply(this,[this]),this._occurr=null,this},SequenceDiagramBuilder.prototype._find_or_create=function(sth){var a,obj,r;if(a=core._normalize(sth),r=core._to_ref(a.id),this._diagram[r])return this._diagram[r];switch(obj=new SequenceParticipant(sth),this._diagram._reg_by_ref(a.id,obj),this._diagram.append(obj),typeof sth){case"string":this._diagram._var(r,obj);break;case"object":this._diagram._var(core._to_ref(a.id),obj);break;default:throw console.error("It must be string or object for",eth),Error("Unrecognized argument: "+e)}return obj},SequenceDiagramBuilder.prototype.message=function(a,b,c){var actee,actname,callback,e,iact,it,msg,norm,stereotype;if(actname=a,"string"!=typeof a||"function"!=typeof b&&void 0!==b)if("string"==typeof a&&"string"==typeof b)"function"==typeof c?(actee=this._find_or_create(b),callback=c):void 0===c&&(actee=this._find_or_create(b),callback=null);else if("object"==typeof a&&"string"==typeof b){actee=this._find_or_create(b),callback=c;for(e in a)switch(e){case"asynchronous":actname=a[e],stereotype="asynchronous"}}else{if("string"!=typeof a||"object"!=typeof b)throw msg="invalid arguments",console.error("SequenceDiagramBuilder::message",msg,a,b,c),Error(msg,a,b,c);norm=JUMLY.Identity.normalize(b),actee=this._find_or_create(norm),callback=c}else actee=this._curr_actor(),callback=b;return iact=this._curr_occurr().interact(actee),iact.find(".name").text(actname).end().find(".message").addClass(stereotype),it=new SequenceDiagramBuilder(this._diagram,iact._actee),null!=callback&&callback.apply(it,[]),it},SequenceDiagramBuilder.prototype.create=function(a,b,c){var actee,async,callback,ctxt,e,iact,id,name,norm,occurr;return"string"==typeof a&&"function"==typeof b?(name=null,actee=a,callback=b):"string"==typeof a&&"string"==typeof b&&"function"==typeof c?(name=a,actee=b,callback=c):"string"==typeof a&&void 0===b?(name=null,actee=a,callback=null):"object"==typeof a&&(e=core._normalize(a),actee=e.name,async=null!=a.asynchronous,"function"==typeof b&&(callback=b)),"string"==typeof a?id=core._to_id(actee):(norm=core._normalize(a),id=norm.id,actee=norm.name),iact=this._curr_occurr().create({id:id,name:actee}),name&&iact.name(name),async&&iact.find(".message:eq(0)").addClass("asynchronous"),occurr=iact._actee,ctxt=new SequenceDiagramBuilder(this._diagram,occurr),null!=callback&&callback.apply(ctxt,[]),this._var(id,occurr._actor),this._diagram._reg_by_ref(id,occurr._actor),ctxt},SequenceDiagramBuilder.prototype._var=function(varname,refobj){var ref;return ref=core._to_ref(varname),this._diagram._var(ref,refobj)},SequenceDiagramBuilder.prototype.destroy=function(a){return this._curr_occurr().destroy(this._find_or_create(a)),null},SequenceDiagramBuilder.prototype.reply=function(a,b){var f,n,obj,ref;return obj=b,"string"==typeof b&&(ref=core._to_ref(core._to_id(b)),this._diagram[ref]&&(obj=this._diagram[ref])),f=function(occur,n){return occur.is_on_another()?f(occur._parent_occurr(),n+1):n},n=f(this._curr_occurr(),0),this._curr_occurr().parents(".interaction:eq("+n+")").data("_self").reply({name:a,".actee":obj}),null},SequenceDiagramBuilder.prototype.ref=function(a){var occur,ref;return occur=this._curr_occurr(),ref=new SequenceRef(a),occur?occur.append(ref):this.diagram().append(ref),this._refer(ref,{by:a}),ref},SequenceDiagramBuilder.prototype.lost=function(){return this._curr_occurr.lost(),null},SequenceDiagramBuilder.prototype.fragment=function(nctx){var ctx,frag,name;for(name in nctx)return ctx=nctx[name],frag=this._fragment(ctx,{label:name}),this._refer(frag,{by:name}),void 0},SequenceDiagramBuilder.prototype.loop=function(a){var last;return last=[].slice.apply(arguments).pop(),$.isFunction(last)?this._fragment(last,{kind:"loop",label:"Loop"},a):void 0},SequenceDiagramBuilder.prototype._fragment=function(last,opts,desc){var frag,kids,newones;return kids=this._curr_occurr().find("> *"),last.apply(this,[]),newones=this._curr_occurr().find("> *").not(kids),newones.length>0&&(frag=new SequenceFragment,opts.kind&&frag.addClass(opts.kind),frag.enclose(newones),frag.find(".name:first").html(opts.label)),"string"==typeof desc&&frag.find(".condition").html(desc),frag},SequenceDiagramBuilder.prototype.alt=function(ints){var iacts,name,_new_act;iacts={},self=this;for(name in ints){if("function"!=typeof ints[name])break;_new_act=function(name,act){return function(){var nodes,_;return nodes=[],_=function(it){var node;return node=(null!=it?it.constructor:void 0)===SequenceDiagramBuilder?it._curr_occurr().parent(".interaction:eq(0)"):it,nodes.push(node)},act.apply({_curr_actor:function(){return self._curr_actor.apply(self,arguments)},message:function(){return _(self.message.apply(self,arguments))},loop:function(){return _(self.loop.apply(self,arguments))},ref:function(){return _(self.ref.apply(self,arguments))}}),nodes}},iacts[name]=_new_act(name,ints[name])}return this._curr_occurr().interact({stereotype:".alt"},iacts),this},SequenceDiagramBuilder.prototype.reactivate=function(a,b,c){var e,occurr;return a.constructor===this.constructor?(e=a._curr_occurr.parents(".interaction:eq(0)"),this._curr_actor().activate().append(e),a):(occurr=this._curr_actor().activate(),this._occurr=occurr,this.message(a,b,c))},SequenceDiagramBuilder.prototype.css=function(styles){return this._diagram.css(styles)},SequenceDiagramBuilder.prototype.find=function(selector){return this._diagram.find(selector)},NoteElement=self.require("NoteElement"),SequenceDiagramBuilder.prototype.note=function(text,opts){var note;return note=new NoteElement(text,opts),this._curr_occurr().append(note)},SequenceDiagramBuilder.prototype.compose=function(opts){return"function"==typeof opts?opts(this._diagram):null!=opts&&opts.append(this._diagram),this._diagram.compose(opts)},SequenceDiagramBuilder.prototype.preferences=function(){return this._diagram.preferences.apply(this._diagram,arguments)},core.env.is_node?module.exports=SequenceDiagramBuilder:core.exports(SequenceDiagramBuilder)}.call(this),function(){var DiagramLayout,HTMLElementLayout,SequenceDiagramLayout,SequenceLifeline,core,self,_,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},DiagramLayout=self.require("DiagramLayout"),$.fn.self=function(){return this.data("_self")},$.fn.selfEach=function(f){return this.each(function(i,e){if(e=$(e).self(),null==e)throw Error("_self have nothing ",e);return f(e),this})},SequenceDiagramLayout=function(_super){function SequenceDiagramLayout(){return _ref=SequenceDiagramLayout.__super__.constructor.apply(this,arguments)}return __extends(SequenceDiagramLayout,_super),SequenceDiagramLayout}(DiagramLayout),SequenceDiagramLayout.prototype._q=function(sel){return $(sel,this.diagram)},SequenceDiagramLayout.prototype._layout=function(){var l,ml,mr,objs,occurs,r;return objs=$(".participant:eq(0) ~ .participant",this.diagram),$(".participant:eq(0)",this.diagram).after(objs),this.align_objects_horizontally(),this._q(".occurrence").each(function(i,e){return $(e).data("_self")._move_horizontally()}),this._q(".occurrence .interaction").selfEach(function(e){return e._compose_()}),this.generate_lifelines_and_align_horizontally(),this.pack_refs_horizontally(),this.pack_fragments_horizontally(),this._q(".create.message").selfEach(function(e){return e._to_be_creation()}),this.align_lifelines_vertically(),this.align_lifelines_stop_horizontally(),this.rebuild_asynchronous_self_calling(),this.render_icons(),this.diagram.find(".return").each(function(i,e){return e=$(e),e.css("margin-top",-e.height()/2)}),occurs=this.diagram.find(".occurrence"),ml=occurs.sort(function(e){return $(e).offset().left}),mr=occurs.sort(function(e){return $(e).offset().left+$(e).outerWidth()-1}),$(ml[0]).addClass("leftmost"),$(mr[mr.length-1]).addClass("rightmost"),objs=this.diagram.find(".participant"),l=objs.min(function(e){return $(e).offset().left}),r=objs.max(function(e){return $(e).offset().left+$(e).outerWidth()-1}),this.diagram.width(r-l+1)},HTMLElementLayout=self.require("HTMLElementLayout"),_=function(opts){return("undefined"!=typeof navigator&&null!==navigator?navigator.userAgent.match(/.*(WebKit).*/):void 0)?opts.webkit:("undefined"!=typeof navigator&&null!==navigator?navigator.userAgent.match(/.*(Gecko).*/):void 0)?opts.gecko:opts.webkit},$.fn.pickup2=function(f0,f1,f2){var prev,_this=this;return 0===this.length?this:(f0(prev=$(this[0])),1===this.length?this:this.slice(1).each(function(i,curr){return curr=$(curr),null!=f2&&i+1===_this.length-1?f2(prev,curr,i+1):f1(prev,curr,i+1),prev=curr}))},SequenceDiagramLayout.prototype.align_objects_horizontally=function(){var f0,f1;return f0=function(a){return a.css("left")===_({webkit:"auto",gecko:"0px"})?a.css({left:0}):void 0},f1=function(a,b){var spacing;return b.css("left")===_({webkit:"auto",gecko:"0px"})?(spacing=new HTMLElementLayout.HorizontalSpacing(a,b),spacing.apply()):void 0},this._q(".participant").pickup2(f0,f1)},SequenceLifeline=self.require("SequenceLifeline"),SequenceDiagramLayout.prototype.generate_lifelines_and_align_horizontally=function(){var diag;return diag=this.diagram,$(".participant",this.diagram).each(function(i,e){var a,obj;return obj=$(e).data("_self"),a=new SequenceLifeline(obj),a.offset({left:obj.offset().left}),a.width(obj.preferred_width()),diag.append(a)})},SequenceDiagramLayout.prototype.pack_refs_horizontally=function(){return this._q(".ref").selfEach(function(ref){var idx,not_defined,parent,pw;return pw=ref.preferred_left_and_width(),ref.offset({left:pw.left}),idx=ref.index(),parent=ref.parent(),ref.detach(),not_defined="0px"===ref.css("width"),0===idx?parent.prepend(ref):ref.insertAfter(parent.find("> *:eq("+(idx-1)+")")),not_defined?ref.width(pw.width):ref.width(parseInt(ref.css("width")))})},SequenceDiagramLayout.prototype.pack_fragments_horizontally=function(){var fixwidth,fragments,left,most;return fragments=$("> .fragment",this.diagram),fragments.length>0&&(most=this._q(".participant").mostLeftRight(),left=fragments.offset().left,fragments.width(most.right-left+(most.left-left))),fixwidth=function(fragment){var msg;return most=$(".occurrence, .message, .fragment",fragment).not(".return, .lost").mostLeftRight(),fragment.width(most.width()-(fragment.outerWidth()-fragment.width())),msg=fragment.find("> .interaction > .message").data("_self"),(null!=msg?msg.isTowardLeft():void 0)?fragment.offset({left:most.left}).find("> .interaction > .occurrence").each(function(i,occurr){return occurr=occurr.data("_self"),occurr._move_horizontally().prev().offset({left:occurr.offset().left})}):void 0},this._q(".occurrence > .fragment").selfEach(fixwidth).parents(".occurrence > .fragment").selfEach(fixwidth)},SequenceDiagramLayout.prototype.align_lifelines_vertically=function(){var last,mh,min,nodes;return nodes=this.diagram.find(".interaction, > .ref"),0!==nodes.length?(nodes.filter(".ref").length>0?(last=nodes.filter(":last"),mh=last.offset().top+last.outerHeight()-nodes.filter(":first").offset().top):mh=this.diagram.find(".interaction:eq(0)").height(),min=this.diagram.find(".participant").min(function(e){return $(e).offset().top}),this._q(".lifeline").each(function(i,e){var a,dh,mt,ot;return a=$(e).data("_self"),a.offset({left:a._object.offset().left}),ot=Math.ceil(a._object.offset().top),dh=ot-min,a.height(mh-dh+16),mt=a.offset().top-(ot+a._object.outerHeight()),a.css({"margin-top":"-"+mt+"px"})})):void 0},SequenceDiagramLayout.prototype.align_lifelines_stop_horizontally=function(){return $(".stop",this.diagram).each(function(i,e){var occurr;return e=$(e),occurr=e.prev(".occurrence"),e.offset({left:occurr.offset().left})})},SequenceDiagramLayout.prototype.rebuild_asynchronous_self_calling=function(){return this.diagram.find(".message.asynchronous").parents(".interaction:eq(0)").each(function(i,e){var iact,msg,occurr,prev;return e=$(e).self(),e.isToSelf()?(iact=e.addClass("activated").addClass("asynchronous"),prev=iact.parents(".interaction:eq(0)"),iact.insertAfter(prev),occurr=iact.css("padding-bottom",0).find("> .occurrence").self()._move_horizontally().css("top",0),msg=iact.find(".message").self(),msg.css("z-index",-1).offset({left:occurr.offset().left,top:prev.find(".occurrence").outerBottom()-msg.height()/3})):void 0})},SequenceDiagramLayout.prototype.render_icons=function(){return this._q(".participant").selfEach(function(e){return"function"==typeof e.renderIcon?e.renderIcon():void 0})},core=self.require("core"),core.env.is_node?module.exports=SequenceDiagramLayout:core.exports(SequenceDiagramLayout)}.call(this),function(){var HTMLElement,IconElement,Path,core,self,_STYLES,_actor,_controller,_entity,_render,_view,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},self.require("jquery.g2d"),_STYLES={lineWidth:1.5,fillStyle:"white",strokeStyle:"gray",shadowBlur:12,shadowColor:"rgba(0,0,0,0.22)",shadowOffsetX:8,shadowOffsetY:5},Path=$.g2d.path,_actor=function(ctx,styles){var exth,lw,r,r0,r1,r2,ret;return r=styles.radius||12,r2=2*r,exth=.25*r,lw=Math.round(styles.lineWidth),r0=function(){return ctx.arc(lw+r,lw+r,r,0,2*Math.PI,!0),ctx.fill(),ctx.shadowColor="transparent",ctx.stroke()},r1=function(){var dh,dv;return dh=3*lw,dv=.77*r2,new Path(ctx).moveTo(0,r2+lw+exth).line(lw+r2+lw,0).moveTo(lw+r,r2+lw).line(0,.35*r2).line(-r,dv).move(r,-dv).line(r,dv),ctx.shadowColor=styles.shadowColor,ctx.stroke()},ret={size:{width:lw+r2+lw,height:lw+2*r2+lw},paths:[r0,r1]}},_view=function(ctx,styles){var extw,lw,r,r0,r1,r2,ret;return r=styles.radius||16,r2=2*r,extw=.4*r,lw=styles.lineWidth,r0=function(){return ctx.arc(lw+r+extw,lw+r,r,0,2*Math.PI,!0),ctx.fill(),ctx.shadowColor="transparent",ctx.stroke()},r1=function(){return new Path(ctx).moveTo(lw,r).line(extw,0).moveTo(lw,0).line(0,r2),ctx.stroke()},ret={size:{width:lw+r2+extw+lw,height:lw+r2+lw},paths:[r0,r1]}},_controller=function(ctx,styles){var dy,effectext,exth,lh,lw,r,r0,r1,r2,ret;return r=styles.radius||16,r2=2*r,exth=.4*r,lw=lh=styles.lineWidth,dy=0,effectext=0,r0=function(){return ctx.arc(lw+r,lw+r+exth,r,0,2*Math.PI,!0),ctx.fill(),ctx.shadowColor="transparent",ctx.stroke()},r1=function(){var x0,x1,y0;return x0=lw+.8*r,x1=lw+1.2*r,y0=lh+exth,new Path(ctx).moveTo(x0,y0).lineTo(x1,lh+exth/4).moveTo(x0,y0).lineTo(x1,lh+7*exth/4),ctx.stroke()},ret={size:{width:lw+r2+lw+effectext,height:lw+r2+lw+effectext+exth},paths:[r0,r1]}},_entity=function(ctx,styles){var exth,lw,r,r0,r1,r2,ret;return r=styles.radius||16,r2=2*r,exth=.4*r,lw=styles.lineWidth,r0=function(){return ctx.arc(lw+r,lw+r,r,0,2*Math.PI,!0),ctx.fill(),ctx.shadowColor="transparent",ctx.stroke()},r1=function(){return ctx.shadowColor=styles.shadowColor,new Path(ctx).moveTo(lw+r,r2).lineTo(lw+r,r2+exth).moveTo(0,r2+exth).lineTo(r2+lw,r2+exth),ctx.stroke()},ret={size:{width:lw+r2+lw,height:lw+r2+exth+lw},paths:[r0,r1]}},_render=function(canvas,renderer,args){var ctx,dh,dw,e,paths,size,styles,_i,_len,_ref,_results;if(canvas.getContext){for(styles=$.extend({},_STYLES,args),ctx=canvas.getContext("2d"),_ref=renderer(ctx,styles),size=_ref.size,paths=_ref.paths,dw=(styles.shadowOffsetX||0)+(styles.shadowBlur/2||0),dh=(styles.shadowOffsetY||0)+(styles.shadowBlur/2||0),$(canvas).attr({width:size.width+dw,height:size.height+dh,"data-actual-width":size.width,"data-actual-height":size.height}),$.extend(ctx,styles),_results=[],_i=0,_len=paths.length;_len>_i;_i++)e=paths[_i],ctx.beginPath(),_results.push(e());return _results}},core=self.require("core"),HTMLElement=self.require("HTMLElement"),IconElement=function(_super){function IconElement(args,opts){var idname;idname=core._normalize(args),IconElement.__super__.constructor.call(this,args,function(me){var canvas,div;return canvas=$("<canvas>"),me.addClass("icon").addClass(opts.kind).append(div=$("<div>").append(canvas)).append($("<div>").addClass("name").append(idname.name)),IconElement.renderer(opts.kind)(canvas[0]),div.css({height:canvas.data("actual-height")})})}return __extends(IconElement,_super),IconElement.renderer=function(type){var r;return r={actor:_actor,view:_view,controller:_controller,entity:_entity},function(canvas,styles){return _render(canvas,r[type],styles)}},IconElement}(HTMLElement),core.env.is_node?module.exports=IconElement:core.exports(IconElement)}.call(this),function(){var Diagram,IconElement,RobustnessDiagram,core,self,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},Diagram=self.require("Diagram"),IconElement=self.require("IconElement"),RobustnessDiagram=function(_super){function RobustnessDiagram(){return _ref=RobustnessDiagram.__super__.constructor.apply(this,arguments)}return __extends(RobustnessDiagram,_super),RobustnessDiagram}(Diagram),core=self.require("core"),RobustnessDiagram.prototype._node_of=function(n,k){var e,id,ref;return id=core._to_id(n),ref=core._to_ref(id),this[ref]?this[ref]:(e=new IconElement(n,{kind:k}),this._reg_by_ref(id,e),e)},core.env.is_node?module.exports=RobustnessDiagram:core.exports(RobustnessDiagram)}.call(this),function(){var DiagramBuilder,IconElement,Relationship,RobustnessDiagram,RobustnessDiagramBuilder,core,self,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},DiagramBuilder=self.require("DiagramBuilder"),RobustnessDiagram=self.require("RobustnessDiagram"),IconElement=self.require("IconElement"),Relationship=self.require("Relationship"),RobustnessDiagramBuilder=function(_super){function RobustnessDiagramBuilder(_diagram){var _ref;this._diagram=_diagram,RobustnessDiagramBuilder.__super__.constructor.call(this),null==(_ref=this._diagram)&&(this._diagram=new RobustnessDiagram)}return __extends(RobustnessDiagramBuilder,_super),RobustnessDiagramBuilder}(DiagramBuilder),RobustnessDiagramBuilder.prototype.build=function(src){var _this=this;return src.data?src.find("*[data-kind]").each(function(e){return e=$(e),_this._diagram.append(new IconElement(e.text(),{kind:$(e).data("kind")}))}):RobustnessDiagramBuilder.__super__.build.call(this,src),this._diagram},core=self.require("core"),RobustnessDiagramBuilder.prototype._node=function(opt,kind){var a,b,f,k;if("string"==typeof opt)return this._diagram.append(a=this._diagram._node_of(opt,kind)),a;if("object"==typeof opt)for(k in opt)if("function"==typeof(f=opt[k]))return a=this._diagram._node_of(k,kind),b=f.apply(this,[]),this._diagram.append(a).append(b),this._diagram.append(new Relationship("",{src:a,dst:b})),a;throw"unexpected: "+typeof opt},RobustnessDiagramBuilder.prototype.actor=function(opt){return this._node(opt,"actor")},RobustnessDiagramBuilder.prototype.view=function(opt){return this._node(opt,"view")},RobustnessDiagramBuilder.prototype.controller=function(opt){return this._node(opt,"controller")},RobustnessDiagramBuilder.prototype.entity=function(opt){return this._node(opt,"entity")},core=self.require("core"),core.env.is_node?module.exports=RobustnessDiagramBuilder:core.exports(RobustnessDiagramBuilder)}.call(this),function(){var DiagramLayout,RobustnessDiagramLayout,core,self,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};self={require:"undefined"!=typeof require?require:JUMLY.require},DiagramLayout=self.require("DiagramLayout"),RobustnessDiagramLayout=function(_super){function RobustnessDiagramLayout(){return _ref=RobustnessDiagramLayout.__super__.constructor.apply(this,arguments)}return __extends(RobustnessDiagramLayout,_super),RobustnessDiagramLayout}(DiagramLayout),RobustnessDiagramLayout.prototype._layout=function(){var elems,mlr,mtb,p;return elems=this.diagram.find(".element"),p=this.diagram.offset(),p.left+=2*parseInt(this.diagram.css("padding-left")),p.top+=2*parseInt(this.diagram.css("padding-top")),elems.each(function(i,e){return $(e).css({position:"absolute"}).offset({left:p.left+120*(i%3),top:p.top+100*(i/3)})}),mlr=elems.mostLeftRight(!0),mtb=elems.mostTopBottom(!0),this.diagram.width(mlr.width()).height(mtb.height()),this.diagram.find(".relationship").each(function(i,e){return $(e).data("_self").render()})},core=self.require("core"),core.env.is_node?module.exports=RobustnessDiagramLayout:core.exports(RobustnessDiagramLayout)}.call(this);